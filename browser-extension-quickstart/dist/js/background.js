(()=>{"use strict";class e{constructor(e,t,n,s=[],r=new Map,o){this.id=e,this.name=t,this.description=n,this.nodes=s,this.variables=r,this.llmProvider=o}async execute(e){var t,n,s,r;if(!this.validateDAG())throw new Error("Invalid workflow: Contains circular dependencies");this.abort=!1,e&&await(null===(n=(t=e.hooks).beforeWorkflow)||void 0===n?void 0:n.call(t,this));const o=new Set,i=new Set,a=async t=>{var n,s,r,l,c;if(this.abort)throw new Error("Abort");if(o.has(t))return;if(i.has(t))throw new Error(`Circular dependency detected at node: ${t}`);const u=this.getNode(t),h={__skip:!1,__abort:!1,variables:this.variables,llmProvider:this.llmProvider,tools:new Map(u.action.tools.map((e=>[e.name,e]))),callback:e,next:()=>h.__skip=!0,abortAll:()=>this.abort=h.__abort=!0};if(e&&await(null===(s=(n=e.hooks).beforeSubtask)||void 0===s?void 0:s.call(n,u,h)),h.__abort)throw new Error("Abort");if(h.__skip)return;i.add(t);for(const e of u.dependencies)await a(e);const d={};for(const e of u.dependencies){const t=this.getNode(e);d[e]=t.output.value}u.input.value=d,u.output.value=await u.action.execute(u.input.value,h),i.delete(t),o.add(t),e&&await(null===(l=(r=e.hooks).afterSubtask)||void 0===l?void 0:l.call(r,u,h,null===(c=u.output)||void 0===c?void 0:c.value))},l=this.nodes.filter((e=>!this.nodes.some((t=>t.dependencies.includes(e.id)))));await Promise.all(l.map((e=>a(e.id)))),e&&await(null===(r=(s=e.hooks).afterWorkflow)||void 0===r?void 0:r.call(s,this,this.variables))}addNode(e){if(this.nodes.some((t=>t.id===e.id)))throw new Error(`Node with id ${e.id} already exists`);this.nodes.push(e)}removeNode(e){const t=this.nodes.findIndex((t=>t.id===e));if(-1===t)throw new Error(`Node with id ${e} not found`);const n=this.nodes.filter((t=>t.dependencies.includes(e)));if(n.length>0)throw new Error(`Cannot remove node ${e}: Nodes ${n.map((e=>e.id)).join(", ")} depend on it`);this.nodes.splice(t,1)}getNode(e){const t=this.nodes.find((t=>t.id===e));if(!t)throw new Error(`Node with id ${e} not found`);return t}validateDAG(){const e=new Set,t=new Set,n=s=>{if(t.has(s))return!0;if(e.has(s))return!1;e.add(s),t.add(s);const r=this.getNode(s);for(const e of r.dependencies)if(n(e))return!0;return t.delete(s),!1};return!this.nodes.some((e=>n(e.id)))}}class t{constructor(){this.name="write_context",this.description="Write a value to the workflow context. Use this to store intermediate results or outputs.",this.input_schema={type:"object",properties:{key:{type:"string",description:"The key to store the value under"},value:{type:"string",description:"The value to store (must be JSON stringified if object/array)"}},required:["key","value"]}}async execute(e,t){const{key:n,value:s}=t;try{const t=JSON.parse(s);e.variables.set(n,t)}catch(t){e.variables.set(n,s)}return{success:!0,key:n,value:s}}}class n{constructor(e,n,s,r,o,i,a){this.type=e,this.name=n,this.description=s,this.tools=r,this.llmProvider=o,this.llmConfig=i,this.maxRounds=10,this.writeContextTool=new t,this.tools=[...r,this.writeContextTool],(null==a?void 0:a.maxRounds)&&(this.maxRounds=a.maxRounds)}async executeSingleRound(e,t,n,s){const r=[];let o=!1,i=null,a="",l=null,c=null,u=null;const h={onContent:e=>{e.trim()&&(a+=e)},onToolUse:async e=>{console.log("Tool Call:",e.name,e.input),o=!0;const t=n.get(e.name);if(!t)throw new Error(`Tool not found: ${e.name}`);l={role:"assistant",content:[{type:"tool_use",id:e.id,name:t.name,input:e.input}]},u=(async()=>{try{if(s.__skip=!1,s.callback&&s.callback.hooks.beforeToolUse){let n=await s.callback.hooks.beforeToolUse(t,s,e.input);n&&(e.input=n)}if(s.__skip||s.__abort)return void(c={role:"user",content:[{type:"tool_result",tool_use_id:e.id,content:"skip"}]});let n=await t.execute(s,e.input);if(s.callback&&s.callback.hooks.afterToolUse){let e=await s.callback.hooks.afterToolUse(t,s,n);e&&(n=e)}const r={role:"user",content:[n.image&&n.image.type?{type:"tool_result",tool_use_id:e.id,content:n.text?[{type:"image",source:n.image},{type:"text",text:n.text}]:[{type:"image",source:n.image}]}:{type:"tool_result",tool_use_id:e.id,content:[{type:"text",text:JSON.stringify(n)}]}]};c=r,console.log("Tool Result:",n)}catch(t){const n=t instanceof Error?t.message:"Unknown error occurred",s={role:"user",content:[{type:"tool_result",tool_use_id:e.id,content:[{type:"text",text:`Error: ${n}`}],is_error:!0}]};c=s,console.error("Tool Error:",t)}})()},onComplete:e=>{i=e},onError:e=>{console.error("Stream Error:",e)}};if(this.handleHistoryImageMessages(e),await this.llmProvider.generateStream(e,t,h),u&&await u,s.__abort)throw new Error("Abort");return a&&r.push({role:"assistant",content:a}),l&&r.push(l),c&&r.push(c),{response:i,hasToolUse:o,roundMessages:r}}handleHistoryImageMessages(e){let t=!0;for(let n=e.length-1;n>=0;n--){const s=e[n];if("user"===s.role){if(t){t=!1;continue}if(s.content instanceof Array){let e=s.content;for(let t=0;t<e.length;t++)if("tool_result"===e[t].type&&e[t].content instanceof Array){let n=e[t].content;if(n.length>0)for(let e=n.length-1;e>=0;e--)"image"===n[e].type&&n.splice(e,1);else"image"===n[0].type&&(n=[{type:"text",text:"ok"}])}}}}}async execute(e,t,n){var s;const r=function(e){return{name:"return_output",description:"Return the final output of this action. Use this to return a value matching the required output schema.",input_schema:{type:"object",properties:{value:e||{type:["string","number","boolean","object","null"],description:"The output value"}},required:["value"]},async execute(e,t){const{value:n}=t;return e.variables.set("__action_output",n),{returned:n}}}}(n),o=new Map;this.tools.forEach((e=>o.set(e.name,e))),null===(s=t.tools)||void 0===s||s.forEach((e=>o.set(e.name,e))),o.set(r.name,r);const i=[{role:"system",content:this.formatSystemPrompt()},{role:"user",content:this.formatUserPrompt(t,e)}];console.log("Starting LLM conversation..."),console.log("Initial messages:",i),console.log("Output schema:",n);const a={...this.llmConfig,tools:Array.from(o.values()).map((e=>({name:e.name,description:e.description,input_schema:e.input_schema})))};let l=0;for(;l<this.maxRounds;){l++,console.log(`Starting round ${l} of ${this.maxRounds}`),console.log("Current conversation status:",JSON.stringify(i,null,2));const{response:e,hasToolUse:n,roundMessages:s}=await this.executeSingleRound(i,a,o,t);if(i.push(...s),!n&&e){console.log("No tool use detected, requesting explicit return"),console.log("Response:",e);const n={...a,tools:[{name:r.name,description:r.description,input_schema:r.input_schema}]};i.push({role:"user",content:"Please process the above information and return a final result using the return_output tool."});const{roundMessages:s}=await this.executeSingleRound(i,n,new Map([[r.name,r]]),t);i.push(...s);break}if(null==e?void 0:e.toolCalls.some((e=>"return_output"===e.name))){console.log("Task completed with return_output tool");break}if(l===this.maxRounds){console.log("Max rounds reached, requesting explicit return");const e={...a,tools:[{name:r.name,description:r.description,input_schema:r.input_schema}]};i.push({role:"user",content:"Maximum number of steps reached. Please return the best result possible with the return_output tool."});const{roundMessages:n}=await this.executeSingleRound(i,e,new Map([[r.name,r]]),t);i.push(...n)}}const c=t.variables.get("__action_output");return t.variables.delete("__action_output"),void 0===c?(console.warn("Action completed without returning a value"),{}):c}formatSystemPrompt(){return"You are a task executor. You need to complete the task specified by the user, using the tools provided. When you need to store results or outputs, use the write_context tool. When you are ready to return the final output, use the return_output tool.\n\n    Remember to:\n    1. Use tools when needed to accomplish the task\n    2. Store important results using write_context, including intermediate and final results\n    3. Think step by step about what needs to be done"}formatUserPrompt(e,t){const n=Array.from(e.variables.entries()).map((([e,t])=>`${e}: ${JSON.stringify(t)}`)).join("\n");return`You are executing the action "${this.name}". The specific instructions are: "${this.description}". You have access to the following context:\n\n    ${n||"No context variables set"}\n\n    You have been provided with the following input:\n    ${("string"==typeof t?t:JSON.stringify(t,null,2))||"No additional input provided"}\n    `}static createPromptAction(e,t,s,r,o){return new n("prompt",e,t,s,r,o)}}const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));let r;const o=new Uint8Array(16);var i={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};class a{constructor(e,t){this.llmProvider=e,this.toolRegistry=t,this.message_history=[]}async generateWorkflow(e){return this.doGenerateWorkflow(e,!1)}async modifyWorkflow(e){return this.doGenerateWorkflow(e,!0)}async doGenerateWorkflow(e,t){const n=function(e){return{formatSystemPrompt:()=>`You are a workflow generation assistant that creates Eko framework workflows.\nThe following tools are available:\n\n${e.map((e=>`\nTool: ${e.name}\nDescription: ${e.description}\nInput Schema: ${JSON.stringify(e.input_schema,null,2)}\n        `)).join("\n")}\n\nGenerate a complete workflow that:\n1. Only uses the tools listed above\n2. Properly sequences tool usage based on dependencies\n3. Ensures each action has appropriate input/output schemas, and that the "tools" field in each action is populated with the sufficient subset of all available tools needed to complete the action\n4. Creates a clear, logical flow to accomplish the user's goal\n5. Includes detailed descriptions for each action, ensuring that the actions, when combined, is a complete solution to the user's problem`,formatUserPrompt:e=>`Create a workflow for the following requirement: ${e}`,modifyUserPrompt:e=>`Modify workflow: ${e}`}}(this.toolRegistry.getToolDefinitions());let a=[];t?(a=this.message_history,a.push({role:"user",content:n.modifyUserPrompt(e)})):a=this.message_history=[{role:"system",content:n.formatSystemPrompt()},{role:"user",content:n.formatUserPrompt(e)}];const l={temperature:.7,maxTokens:8192,tools:[(c=this.toolRegistry,{name:"generate_workflow",description:"Generate a workflow following the Eko framework DSL schema.\nThe workflow must only use the available tools and ensure proper dependencies between nodes.",input_schema:{type:"object",properties:{workflow:c.getWorkflowSchema()},required:["workflow"]}})],toolChoice:{type:"tool",name:"generate_workflow"}};var c;const u=await this.llmProvider.generateText(a,l);if(!u.toolCalls.length||!u.toolCalls[0].input.workflow)throw a.pop(),new Error("Failed to generate workflow: Invalid response from LLM");a.push({role:"assistant",content:[{type:"tool_use",id:u.toolCalls[0].id,name:u.toolCalls[0].name,input:u.toolCalls[0].input}]},{role:"user",content:[{type:"tool_result",tool_use_id:u.toolCalls[0].id,content:"ok"}]});const h=u.toolCalls[0].input.workflow;for(const e of h.nodes)if(!this.toolRegistry.hasTools(e.action.tools))throw new Error(`Workflow contains undefined tools: ${e.action.tools}`);return h.id||(h.id=function(e){if(i.randomUUID&&!e)return i.randomUUID();const t=(e=e||{}).random??e.rng?.()??function(){if(!r){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");r=crypto.getRandomValues.bind(crypto)}return r(o)}();if(t.length<16)throw new Error("Random bytes length must be >= 16");return t[6]=15&t[6]|64,t[8]=63&t[8]|128,function(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}(t)}()),this.createWorkflowFromData(h)}createWorkflowFromData(t){const s=new e(t.id,t.name,t.description||"",[],new Map(Object.entries(t.variables||{})),this.llmProvider);return Array.isArray(t.nodes)&&t.nodes.forEach((e=>{const t=e.action.tools.map((e=>this.toolRegistry.getTool(e))),r=n.createPromptAction(e.action.name,e.action.description,t,this.llmProvider,{maxTokens:1e3}),o={id:e.id,name:e.name||e.id,input:e.input||{type:"any",schema:{},value:void 0},output:e.output||{type:"any",schema:{},value:void 0},action:r,dependencies:e.dependencies||[]};s.addNode(o)})),s}}const l="0.33.1";let c,u,h,d,p,f,m=!1,g=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};c||function(e,t={auto:!1}){if(m)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${e.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(c)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${e.kind}'\` after \`import '@anthropic-ai/sdk/shims/${c}'\``);m=t.auto,c=e.kind,u=e.fetch,h=e.File,d=e.ReadableStream,p=e.getDefaultAgent,f=e.fileFromPath}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import … from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let n,s,r,o;try{n=fetch,s=Request,r=Response,o=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:s,Response:r,Headers:o,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new g(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class w extends Error{}let y=class e extends w{constructor(t,n,s,r){super(`${e.makeMessage(t,n,s)}`),this.status=t,this.headers=r,this.request_id=r?.["request-id"],this.error=n}static makeMessage(e,t,n){const s=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(t,n,s,r){if(!t||!r)return new _({message:s,cause:se(n)});const o=n;return 400===t?new x(t,o,s,r):401===t?new k(t,o,s,r):403===t?new S(t,o,s,r):404===t?new I(t,o,s,r):409===t?new E(t,o,s,r):422===t?new R(t,o,s,r):429===t?new A(t,o,s,r):t>=500?new P(t,o,s,r):new e(t,o,s,r)}},b=class extends y{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},_=class extends y{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},v=class extends _{constructor({message:e}={}){super({message:e??"Request timed out."})}},x=class extends y{},k=class extends y{},S=class extends y{},I=class extends y{},E=class extends y{},R=class extends y{},A=class extends y{},P=class extends y{},T=class e{constructor(){this.buffer=[],this.trailingCR=!1}decode(t){let n=this.decodeText(t);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const s=e.NEWLINE_CHARS.has(n[n.length-1]||"");let r=n.split(e.NEWLINE_REGEXP);return s&&r.pop(),1!==r.length||s?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),s||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new w(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new w(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new w("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};T.NEWLINE_CHARS=new Set(["\n","\r"]),T.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let C=class e{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(t,n){let s=!1;return new e((async function*(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let e=!1;try{for await(const e of async function*(e,t){if(!e.body)throw t.abort(),new w("Attempted to iterate over a response with no body");const n=new $,s=new T,r=M(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let s,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(s=O(t));)yield t.slice(0,s),t=t.slice(s)}t.length>0&&(yield t)}(r))for(const t of s.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of s.flush()){const t=n.decode(e);t&&(yield t)}}(t,n)){if("completion"===e.event)try{yield JSON.parse(e.data)}catch(t){throw console.error("Could not parse message into JSON:",e.data),console.error("From chunk:",e.raw),t}if("message_start"===e.event||"message_delta"===e.event||"message_stop"===e.event||"content_block_start"===e.event||"content_block_delta"===e.event||"content_block_stop"===e.event)try{yield JSON.parse(e.data)}catch(t){throw console.error("Could not parse message into JSON:",e.data),console.error("From chunk:",e.raw),t}if("ping"!==e.event&&"error"===e.event)throw y.generate(void 0,`SSE Error: ${e.data}`,e.data,H(t.headers))}e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||n.abort()}}),n)}static fromReadableStream(t,n){let s=!1;return new e((async function*(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let e=!1;try{for await(const n of async function*(){const e=new T,n=M(t);for await(const t of n)for(const n of e.decode(t))yield n;for(const t of e.flush())yield t}())e||n&&(yield JSON.parse(n));e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||n.abort()}}),n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const t=[],n=[],s=this.iterator(),r=e=>({next:()=>{if(0===e.length){const e=s.next();t.push(e),n.push(e)}return e.shift()}});return[new e((()=>r(t)),this.controller),new e((()=>r(n)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new d({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:r}=await t.next();if(r)return e.close();const o=n.encode(JSON.stringify(s)+"\n");e.enqueue(o)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}};function O(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}let $=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return s.startsWith(" ")&&(s=s.substring(1)),"event"===t?this.event=s:"data"===t&&this.data.push(s),null}};function M(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const j=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer,N=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,q=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag];var L;async function U(e){const{response:t}=e;if(e.options.stream)return le("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):C.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return le("response",t.status,t.url,t.headers,e),D(e,t)}const s=await t.text();return le("response",t.status,t.url,t.headers,s),s}function D(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("request-id"),enumerable:!1})}let B=class e extends Promise{constructor(e,t=U){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(t){return new e(this.responsePromise,(async e=>D(t(await this.parseResponse(e),e),e.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},W=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:r}){this.baseURL=e,this.maxRetries=ne("maxRetries",t),this.timeout=ne("timeout",n),this.httpAgent=s,this.fetch=r??u}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Q(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${ce()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const s=n&&j(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:s}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:s,query:r,headers:o={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:q(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,a=this.calculateContentLength(i),l=this.buildURL(s,r);"timeout"in e&&ne("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??p(l),h=c+1e3;return"number"==typeof u?.options?.timeout&&h>(u.options.timeout??0)&&(u.options.timeout=h),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey),{req:{method:n,...i&&{body:i},headers:this.buildHeaders({options:e,headers:o,contentLength:a,retryCount:t}),...u&&{agent:u},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){const r={};n&&(r["content-length"]=n);const o=this.defaultHeaders(e);return ae(r,o),ae(r,t),q(e.body)&&"node"!==c&&delete r["content-type"],void 0===ue(o,"x-stainless-retry-count")&&void 0===ue(t,"x-stainless-retry-count")&&(r["x-stainless-retry-count"]=String(s)),this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,s){return y.generate(e,t,n,s)}request(e,t=null){return new B(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,s=n.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(n);const{req:r,url:o,timeout:i}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(r,{url:o,options:n}),le("request",o,n,r.headers),n.signal?.aborted)throw new b;const a=new AbortController,l=await this.fetchWithTimeout(o,r,i,a).catch(se);if(l instanceof Error){if(n.signal?.aborted)throw new b;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new v;throw new _({cause:l})}const c=H(l.headers);if(!l.ok){if(t&&this.shouldRetry(l))return le(`response (error; retrying, ${t} attempts remaining)`,l.status,o,c),this.retryRequest(n,t,c);const e=await l.text().catch((e=>se(e).message)),s=Y(e),r=s?void 0:e;throw le(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,o,c,r),this.makeStatusError(l.status,s,r,c)}return{response:l,options:n,controller:a}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new X(this,n,e)}buildURL(e,t){const n=ee(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return oe(s)||(t={...s,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new w(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,s){const{signal:r,...o}=t||{};r&&r.addEventListener("abort",(()=>s.abort()));const i=setTimeout((()=>s.abort()),n);return this.fetch.call(void 0,e,{signal:s.signal,...o}).finally((()=>{clearTimeout(i)}))}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let s;const r=n?.["retry-after-ms"];if(r){const e=parseFloat(r);Number.isNaN(e)||(s=e)}const o=n?.["retry-after"];if(o&&!s){const e=parseFloat(o);s=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}return await te(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${l}`}},F=class{constructor(e,t,n,s){L.set(this,void 0),function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===s?r.call(e,n):r?r.value=n:t.set(e,n)}(this,L,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new w("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,s]of n)e.url.searchParams.set(t,s);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)}(this,L,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(L=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}},X=class extends B{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await U(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}};const H=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),J={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},V=e=>"object"==typeof e&&null!==e&&!oe(e)&&Object.keys(e).every((e=>ie(J,e))),K=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",G=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let z;const Q=()=>z??(z=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":l,"X-Stainless-OS":G(Deno.build.os),"X-Stainless-Arch":K(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":l,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":l,"X-Stainless-OS":G(process.platform),"X-Stainless-Arch":K(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":l,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":l,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),Y=e=>{try{return JSON.parse(e)}catch(e){return}},Z=/^[a-z][a-z0-9+.-]*:/i,ee=e=>Z.test(e),te=e=>new Promise((t=>setTimeout(t,e))),ne=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new w(`${e} must be an integer`);if(t<0)throw new w(`${e} must be a positive integer`);return t},se=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(String(e))},re=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function oe(e){if(!e)return!0;for(const t in e)return!1;return!0}function ie(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ae(e,t){for(const n in t){if(!ie(t,n))continue;const s=n.toLowerCase();if(!s)continue;const r=t[n];null===r?delete e[s]:void 0!==r&&(e[s]=r)}}function le(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`Anthropic:DEBUG:${e}`,...t)}const ce=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),ue=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const s=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const r of[t,n,t.toUpperCase(),s]){const t=e.get(r);if(t)return t}}for(const[s,r]of Object.entries(e))if(s.toLowerCase()===n)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${t} header, using the first entry.`),r[0]):r};let he=class extends F{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1,this.first_id=n.first_id||null,this.last_id=n.last_id||null}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){if(this.options.query?.before_id){const e=this.first_id;return e?{params:{before_id:e}}:null}const e=this.last_id;return e?{params:{after_id:e}}:null}},de=class{constructor(e){this._client=e}},pe=class extends de{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return V(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",fe,{query:e,...t})}};class fe extends he{}pe.BetaModelInfosPage=fe;class me{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){const e=new T;for await(const t of this.iterator)for(const n of e.decode(t))yield JSON.parse(n);for(const t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new w("Attempted to iterate over a response with no body");return new me(M(e.body),t)}}let ge=class extends de{create(e,t){const{betas:n,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...t,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}retrieve(e,t={},n){if(V(t))return this.retrieve(e,{},t);const{betas:s}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...n,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...n?.headers}})}list(e={},t){if(V(e))return this.list({},e);const{betas:n,...s}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",we,{query:s,...t,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}cancel(e,t={},n){if(V(t))return this.cancel(e,{},t);const{betas:s}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...n,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...n?.headers}})}async results(e,t={},n){if(V(t))return this.results(e,{},t);const s=await this.retrieve(e);if(!s.results_url)throw new w(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);const{betas:r}=t;return this._client.get(s.results_url,{...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n?.headers},__binaryResponse:!0})._thenUnwrap(((e,t)=>me.fromResponse(t.response,t.controller)))}};class we extends he{}ge.BetaMessageBatchesPage=we;let ye=class extends de{constructor(){super(...arguments),this.batches=new ge(this._client)}create(e,t){const{betas:n,...s}=e;return this._client.post("/v1/messages?beta=true",{body:s,timeout:this._client._options.timeout??6e5,...t,headers:{...null!=n?.toString()?{"anthropic-beta":n?.toString()}:void 0,...t?.headers},stream:e.stream??!1})}countTokens(e,t){const{betas:n,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...t,headers:{"anthropic-beta":[...n??[],"token-counting-2024-11-01"].toString(),...t?.headers}})}};ye.Batches=ge,ye.BetaMessageBatchesPage=we;let be=class extends de{constructor(){super(...arguments),this.models=new pe(this._client),this.messages=new ye(this._client)}};be.Models=pe,be.BetaModelInfosPage=fe,be.Messages=ye;let _e=class extends de{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}},ve=class extends de{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return V(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",xe,{query:e,...t})}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){const n=await this.retrieve(e);if(!n.results_url)throw new w(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);return this._client.get(n.results_url,{...t,__binaryResponse:!0})._thenUnwrap(((e,t)=>me.fromResponse(t.response,t.controller)))}};class xe extends he{}ve.MessageBatchesPage=xe;const ke=e=>{if(0===e.length)return e;let t=e[e.length-1];switch(t.type){case"separator":return e=e.slice(0,e.length-1),ke(e);case"number":let n=t.value[t.value.length-1];if("."===n||"-"===n)return e=e.slice(0,e.length-1),ke(e);case"string":let s=e[e.length-2];if("delimiter"===s?.type)return e=e.slice(0,e.length-1),ke(e);if("brace"===s?.type&&"{"===s.value)return e=e.slice(0,e.length-1),ke(e);break;case"delimiter":return e=e.slice(0,e.length-1),ke(e)}return e};var Se,Ie,Ee,Re,Ae,Pe,Te,Ce,Oe,$e,Me,je,Ne,qe,Le,Ue,De,Be,We,Fe,Xe=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},He=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};const Je="__json_buf";class Ve{constructor(){Se.add(this),this.messages=[],this.receivedMessages=[],Ie.set(this,void 0),this.controller=new AbortController,Ee.set(this,void 0),Re.set(this,(()=>{})),Ae.set(this,(()=>{})),Pe.set(this,void 0),Te.set(this,(()=>{})),Ce.set(this,(()=>{})),Oe.set(this,{}),$e.set(this,!1),Me.set(this,!1),je.set(this,!1),Ne.set(this,!1),Ue.set(this,(e=>{if(Xe(this,Me,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new b),e instanceof b)return Xe(this,je,!0,"f"),this._emit("abort",e);if(e instanceof w)return this._emit("error",e);if(e instanceof Error){const t=new w(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new w(String(e)))})),Xe(this,Ee,new Promise(((e,t)=>{Xe(this,Re,e,"f"),Xe(this,Ae,t,"f")})),"f"),Xe(this,Pe,new Promise(((e,t)=>{Xe(this,Te,e,"f"),Xe(this,Ce,t,"f")})),"f"),He(this,Ee,"f").catch((()=>{})),He(this,Pe,"f").catch((()=>{}))}static fromReadableStream(e){const t=new Ve;return t._run((()=>t._fromReadableStream(e))),t}static createMessage(e,t,n){const s=new Ve;for(const e of t.messages)s._addMessageParam(e);return s._run((()=>s._createMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}_run(e){e().then((()=>{this._emitFinal(),this._emit("end")}),He(this,Ue,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort()))),He(this,Se,"m",De).call(this);const r=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of r)He(this,Se,"m",Be).call(this,e);if(r.controller.signal?.aborted)throw new b;He(this,Se,"m",We).call(this)}_connected(){this.ended||(He(this,Re,"f").call(this),this._emit("connect"))}get ended(){return He(this,$e,"f")}get errored(){return He(this,Me,"f")}get aborted(){return He(this,je,"f")}abort(){this.controller.abort()}on(e,t){return(He(this,Oe,"f")[e]||(He(this,Oe,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=He(this,Oe,"f")[e];if(!n)return this;const s=n.findIndex((e=>e.listener===t));return s>=0&&n.splice(s,1),this}once(e,t){return(He(this,Oe,"f")[e]||(He(this,Oe,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Xe(this,Ne,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Xe(this,Ne,!0,"f"),await He(this,Pe,"f")}get currentMessage(){return He(this,Ie,"f")}async finalMessage(){return await this.done(),He(this,Se,"m",qe).call(this)}async finalText(){return await this.done(),He(this,Se,"m",Le).call(this)}_emit(e,...t){if(He(this,$e,"f"))return;"end"===e&&(Xe(this,$e,!0,"f"),He(this,Te,"f").call(this));const n=He(this,Oe,"f")[e];if(n&&(He(this,Oe,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return He(this,Ne,"f")||n?.length||Promise.reject(e),He(this,Ae,"f").call(this,e),He(this,Ce,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];He(this,Ne,"f")||n?.length||Promise.reject(e),He(this,Ae,"f").call(this,e),He(this,Ce,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",He(this,Se,"m",qe).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),He(this,Se,"m",De).call(this),this._connected();const s=C.fromReadableStream(e,this.controller);for await(const e of s)He(this,Se,"m",Be).call(this,e);if(s.controller.signal?.aborted)throw new b;He(this,Se,"m",We).call(this)}[(Ie=new WeakMap,Ee=new WeakMap,Re=new WeakMap,Ae=new WeakMap,Pe=new WeakMap,Te=new WeakMap,Ce=new WeakMap,Oe=new WeakMap,$e=new WeakMap,Me=new WeakMap,je=new WeakMap,Ne=new WeakMap,Ue=new WeakMap,Se=new WeakSet,qe=function(){if(0===this.receivedMessages.length)throw new w("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Le=function(){if(0===this.receivedMessages.length)throw new w("stream ended without producing a Message with role=assistant");const e=this.receivedMessages.at(-1).content.filter((e=>"text"===e.type)).map((e=>e.text));if(0===e.length)throw new w("stream ended without producing a content block with type=text");return e.join(" ")},De=function(){this.ended||Xe(this,Ie,void 0,"f")},Be=function(e){if(this.ended)return;const t=He(this,Se,"m",Fe).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{const n=t.content.at(-1);"text_delta"===e.delta.type&&"text"===n.type?this._emit("text",e.delta.text,n.text||""):"input_json_delta"===e.delta.type&&"tool_use"===n.type&&n.input&&this._emit("inputJson",e.delta.partial_json,n.input);break}case"message_stop":this._addMessageParam(t),this._addMessage(t,!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":Xe(this,Ie,t,"f")}},We=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");const e=He(this,Ie,"f");if(!e)throw new w("request ended without sending any chunks");return Xe(this,Ie,void 0,"f"),e},Fe=function(e){let t=He(this,Ie,"f");if("message_start"===e.type){if(t)throw new w(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new w(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,t;case"content_block_start":return t.content.push(e.content_block),t;case"content_block_delta":{const s=t.content.at(e.index);if("text"===s?.type&&"text_delta"===e.delta.type)s.text+=e.delta.text;else if("tool_use"===s?.type&&"input_json_delta"===e.delta.type){let t=s[Je]||"";t+=e.delta.partial_json,Object.defineProperty(s,Je,{value:t,enumerable:!1,writable:!0}),t&&(s.input=(n=t,JSON.parse((e=>{let t="";return e.map((e=>{"string"===e.type?t+='"'+e.value+'"':t+=e.value})),t})((e=>{let t=[];return e.map((e=>{"brace"===e.type&&("{"===e.value?t.push("}"):t.splice(t.lastIndexOf("}"),1)),"paren"===e.type&&("["===e.value?t.push("]"):t.splice(t.lastIndexOf("]"),1))})),t.length>0&&t.reverse().map((t=>{"}"===t?e.push({type:"brace",value:"}"}):"]"===t&&e.push({type:"paren",value:"]"})})),e})(ke((e=>{let t=0,n=[];for(;t<e.length;){let s=e[t];if("\\"===s){t++;continue}if("{"===s){n.push({type:"brace",value:"{"}),t++;continue}if("}"===s){n.push({type:"brace",value:"}"}),t++;continue}if("["===s){n.push({type:"paren",value:"["}),t++;continue}if("]"===s){n.push({type:"paren",value:"]"}),t++;continue}if(":"===s){n.push({type:"separator",value:":"}),t++;continue}if(","===s){n.push({type:"delimiter",value:","}),t++;continue}if('"'===s){let r="",o=!1;for(s=e[++t];'"'!==s;){if(t===e.length){o=!0;break}if("\\"===s){if(t++,t===e.length){o=!0;break}r+=s+e[t],s=e[++t]}else r+=s,s=e[++t]}s=e[++t],o||n.push({type:"string",value:r});continue}if(s&&/\s/.test(s)){t++;continue}let r=/[0-9]/;if(s&&r.test(s)||"-"===s||"."===s){let o="";for("-"===s&&(o+=s,s=e[++t]);s&&r.test(s)||"."===s;)o+=s,s=e[++t];n.push({type:"number",value:o});continue}let o=/[a-z]/i;if(s&&o.test(s)){let r="";for(;s&&o.test(s)&&t!==e.length;)r+=s,s=e[++t];if("true"!=r&&"false"!=r&&"null"!==r){t++;continue}n.push({type:"name",value:r})}else t++}return n})(n)))))))}return t}}var n},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("streamEvent",(n=>{const s=t.shift();s?s.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new C(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}let Ke=class extends de{constructor(){super(...arguments),this.batches=new ve(this._client)}create(e,t){return e.model in Ge&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Ge[e.model]}\nPlease migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}stream(e,t){return Ve.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}};const Ge={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024"};Ke.Batches=ve,Ke.MessageBatchesPage=xe;let ze=class extends de{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return V(e)?this.list({},e):this._client.getAPIList("/v1/models",Qe,{query:e,...t})}};class Qe extends he{}var Ye;ze.ModelInfosPage=Qe;class Ze extends W{constructor({baseURL:e=re("ANTHROPIC_BASE_URL"),apiKey:t=re("ANTHROPIC_API_KEY")??null,authToken:n=re("ANTHROPIC_AUTH_TOKEN")??null,...s}={}){const r={apiKey:t,authToken:n,...s,baseURL:e||"https://api.anthropic.com"};if(!r.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new w("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew Anthropic({ apiKey, dangerouslyAllowBrowser: true });\n");super({baseURL:r.baseURL,timeout:r.timeout??6e5,httpAgent:r.httpAgent,maxRetries:r.maxRetries,fetch:r.fetch}),this.completions=new _e(this),this.messages=new Ke(this),this.models=new ze(this),this.beta=new be(this),this._options=r,this.apiKey=t,this.authToken=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"]||null===t["x-api-key"]||this.authToken&&e.authorization||null===t.authorization))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const t=this.apiKeyAuth(e),n=this.bearerAuth(e);return null==t||oe(t)?null==n||oe(n)?{}:n:t}apiKeyAuth(e){return null==this.apiKey?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return null==this.authToken?{}:{Authorization:`Bearer ${this.authToken}`}}}Ye=Ze,Ze.Anthropic=Ye,Ze.HUMAN_PROMPT="\n\nHuman:",Ze.AI_PROMPT="\n\nAssistant:",Ze.DEFAULT_TIMEOUT=6e5,Ze.AnthropicError=w,Ze.APIError=y,Ze.APIConnectionError=_,Ze.APIConnectionTimeoutError=v,Ze.APIUserAbortError=b,Ze.NotFoundError=I,Ze.ConflictError=E,Ze.RateLimitError=A,Ze.BadRequestError=x,Ze.AuthenticationError=k,Ze.InternalServerError=P,Ze.PermissionDeniedError=S,Ze.UnprocessableEntityError=R,Ze.toFile=async function(e,t,n){if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&j(e))(e=await e))return e;if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const s=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=j(s)?[await s.arrayBuffer()]:[s];return new h(r,t,n)}const s=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(j(e))t.push(await e.arrayBuffer());else{if(!(e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator])(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return N(e.name)||N(e.filename)||N(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=s[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new h(s,t,n)},Ze.fileFromPath=f,Ze.Completions=_e,Ze.Messages=Ke,Ze.Models=ze,Ze.ModelInfosPage=Qe,Ze.Beta=be;class et{constructor(e,t,n){this.defaultModel="claude-3-5-sonnet-20241022",t&&(this.defaultModel=t),"undefined"==typeof window||"undefined"==typeof document||"string"!=typeof e&&!e.apiKey||console.warn("\n        ⚠️ Security Warning:\n        DO NOT use API Keys in browser/frontend code!\n        This will expose your credentials and may lead to unauthorized usage.\n        \n        Best Practices: Configure backend API proxy request through baseURL and request headers.\n\n        Please refer to the link: https://eko.fellou.ai/docs/getting-started/configuration#web-environment\n      "),this.client=new Ze("string"==typeof e?{apiKey:e,dangerouslyAllowBrowser:!0,...n}:e)}processResponse(e){const t=e.content.filter((e=>"tool_use"===e.type)).map((e=>({id:e.id,name:e.name,input:e.input})));return{textContent:e.content.filter((e=>"text"===e.type)).map((e=>e.text)).join("\n")||null,content:e.content,toolCalls:t,stop_reason:e.stop_reason}}async generateText(e,t){let n=e.filter((e=>"system"==e.role)).map((e=>"string"==typeof e.content?e.content:e.content[0].text))[0];const s=await this.client.messages.create({system:n,model:t.model||this.defaultModel,max_tokens:t.maxTokens||1024,temperature:t.temperature,messages:e.filter((e=>"system"!=e.role)),tools:t.tools,tool_choice:t.toolChoice});return this.processResponse(s)}async generateStream(e,t,n){var s,r,o,i,a,l;let c=e.filter((e=>"system"==e.role)).map((e=>"string"==typeof e.content?e.content:e.content[0].text))[0];const u=await this.client.messages.stream({system:c,model:t.model||this.defaultModel,max_tokens:t.maxTokens||4096,temperature:t.temperature,messages:e.filter((e=>"system"!=e.role)),tools:t.tools,tool_choice:t.toolChoice});null===(s=n.onStart)||void 0===s||s.call(n);let h=null;try{for await(const e of u)switch(e.type){case"content_block_start":"text"===e.content_block.type?null===(r=n.onContent)||void 0===r||r.call(n,""):"tool_use"===e.content_block.type&&(h={id:e.content_block.id,name:e.content_block.name,accumulatedJson:""});break;case"content_block_delta":"text_delta"===e.delta.type?null===(o=n.onContent)||void 0===o||o.call(n,e.delta.text):"input_json_delta"===e.delta.type&&h&&(h.accumulatedJson+=e.delta.partial_json);break;case"content_block_stop":if(h){const e={id:h.id,name:h.name,input:JSON.parse(h.accumulatedJson||"{}")};null===(i=n.onToolUse)||void 0===i||i.call(n,e),h=null}}const e=await u.finalMessage();null===(a=n.onComplete)||void 0===a||a.call(n,this.processResponse(e))}catch(e){null===(l=n.onError)||void 0===l||l.call(n,e)}}}const tt="RFC3986",nt={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},st=Array.isArray,rt=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),ot=1024;function it(e,t){if(st(e)){const n=[];for(let s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)}const at=Object.prototype.hasOwnProperty,lt={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},ct=Array.isArray,ut=Array.prototype.push,ht=function(e,t){ut.apply(e,ct(t)?t:[t])},dt=Date.prototype.toISOString,pt={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,s,r)=>{if(0===e.length)return e;let o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===n)return escape(o).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let i="";for(let e=0;e<o.length;e+=ot){const t=o.length>=ot?o.slice(e,e+ot):o,n=[];for(let e=0;e<t.length;++e){let s=t.charCodeAt(e);45===s||46===s||95===s||126===s||s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||"RFC1738"===r&&(40===s||41===s)?n[n.length]=t.charAt(e):s<128?n[n.length]=rt[s]:s<2048?n[n.length]=rt[192|s>>6]+rt[128|63&s]:s<55296||s>=57344?n[n.length]=rt[224|s>>12]+rt[128|s>>6&63]+rt[128|63&s]:(e+=1,s=65536+((1023&s)<<10|1023&t.charCodeAt(e)),n[n.length]=rt[240|s>>18]+rt[128|s>>12&63]+rt[128|s>>6&63]+rt[128|63&s])}i+=n.join("")}return i},encodeValuesOnly:!1,format:tt,formatter:nt[tt],indices:!1,serializeDate:e=>dt.call(e),skipNulls:!1,strictNullHandling:!1},ft={};function mt(e,t,n,s,r,o,i,a,l,c,u,h,d,p,f,m,g,w){let y=e,b=w,_=0,v=!1;for(;void 0!==(b=b.get(ft))&&!v;){const t=b.get(e);if(_+=1,void 0!==t){if(t===_)throw new RangeError("Cyclic object value");v=!0}void 0===b.get(ft)&&(_=0)}if("function"==typeof c?y=c(t,y):y instanceof Date?y=d?.(y):"comma"===n&&ct(y)&&(y=it(y,(function(e){return e instanceof Date?d?.(e):e}))),null===y){if(o)return l&&!m?l(t,pt.encoder,g,"key",p):t;y=""}if("string"==typeof(x=y)||"number"==typeof x||"boolean"==typeof x||"symbol"==typeof x||"bigint"==typeof x||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(y)){if(l){const e=m?t:l(t,pt.encoder,g,"key",p);return[f?.(e)+"="+f?.(l(y,pt.encoder,g,"value",p))]}return[f?.(t)+"="+f?.(String(y))]}var x;const k=[];if(void 0===y)return k;let S;if("comma"===n&&ct(y))m&&l&&(y=it(y,l)),S=[{value:y.length>0?y.join(",")||null:void 0}];else if(ct(c))S=c;else{const e=Object.keys(y);S=u?e.sort(u):e}const I=a?String(t).replace(/\./g,"%2E"):String(t),E=s&&ct(y)&&1===y.length?I+"[]":I;if(r&&ct(y)&&0===y.length)return E+"[]";for(let t=0;t<S.length;++t){const b=S[t],v="object"==typeof b&&void 0!==b.value?b.value:y[b];if(i&&null===v)continue;const x=h&&a?b.replace(/\./g,"%2E"):b,I=ct(y)?"function"==typeof n?n(E,x):E:E+(h?"."+x:"["+x+"]");w.set(e,_);const R=new WeakMap;R.set(ft,w),ht(k,mt(v,I,n,s,r,o,i,a,"comma"===n&&m&&ct(y)?null:l,c,u,h,d,p,f,m,g,R))}return k}const gt="4.79.4";let wt,yt,bt,_t,vt,xt,kt,St,It,Et=!1;class Rt{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}wt||function(e,t={auto:!1}){if(Et)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(wt)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${wt}'\``);Et=t.auto,wt=e.kind,yt=e.fetch,bt=e.FormData,_t=e.File,vt=e.ReadableStream,xt=e.getMultipartRequestOptions,kt=e.getDefaultAgent,St=e.fileFromPath,It=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,s,r,o;try{n=fetch,s=Request,r=Response,o=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:s,Response:r,Headers:o,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Rt(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class At extends Error{}class Pt extends At{constructor(e,t,n,s){super(`${Pt.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.request_id=s?.["x-request-id"],this.error=t;const r=t;this.code=r?.code,this.param=r?.param,this.type=r?.type}static makeMessage(e,t,n){const s=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new Ct({message:n,cause:Sn(t)});const r=t?.error;return 400===e?new $t(e,r,n,s):401===e?new Mt(e,r,n,s):403===e?new jt(e,r,n,s):404===e?new Nt(e,r,n,s):409===e?new qt(e,r,n,s):422===e?new Lt(e,r,n,s):429===e?new Ut(e,r,n,s):e>=500?new Dt(e,r,n,s):new Pt(e,r,n,s)}}class Tt extends Pt{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Ct extends Pt{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Ot extends Ct{constructor({message:e}={}){super({message:e??"Request timed out."})}}class $t extends Pt{}class Mt extends Pt{}class jt extends Pt{}class Nt extends Pt{}class qt extends Pt{}class Lt extends Pt{}class Ut extends Pt{}class Dt extends Pt{}class Bt extends At{constructor(){super("Could not parse response content as the length limit was reached")}}class Wt extends At{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Ft{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=Ft.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(Ft.NEWLINE_REGEXP);return n&&s.pop(),1!==s.length||n?(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),n||(this.buffer=[s.pop()||""]),s):(this.buffer.push(s[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new At(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new At(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new At("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}function Xt(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}Ft.NEWLINE_CHARS=new Set(["\n","\r"]),Ft.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class Ht{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new Ht((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new At("Attempted to iterate over a response with no body");const n=new Vt,s=new Ft,r=Xt(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let s,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(s=Jt(t));)yield t.slice(0,s),t=t.slice(s)}t.length>0&&(yield t)}(r))for(const t of s.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of s.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!s)if(n.data.startsWith("[DONE]"))s=!0;else if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new Pt(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new Pt(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new Ht((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const t of async function*(){const t=new Ft,n=Xt(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())s||t&&(yield JSON.parse(t));s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=s=>({next:()=>{if(0===s.length){const s=n.next();e.push(s),t.push(s)}return s.shift()}});return[new Ht((()=>s(e)),this.controller),new Ht((()=>s(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new vt({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:r}=await t.next();if(r)return e.close();const o=n.encode(JSON.stringify(s)+"\n");e.enqueue(o)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function Jt(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class Vt{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return s.startsWith(" ")&&(s=s.substring(1)),"event"===t?this.event=s:"data"===t&&this.data.push(s),null}}const Kt=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,Gt=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&zt(e),zt=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Qt(e,t,n){if(e=await e,Gt(e))return e;if(Kt(e)){const s=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=zt(s)?[await s.arrayBuffer()]:[s];return new _t(r,t,n)}const s=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(zt(e))t.push(await e.arrayBuffer());else{if(!Zt(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return Yt(e.name)||Yt(e.filename)||Yt(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=s[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new _t(s,t,n)}const Yt=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,Zt=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],en=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],tn=async e=>{const t=await nn(e.body);return xt(t,e)},nn=async e=>{const t=new bt;return await Promise.all(Object.entries(e||{}).map((([e,n])=>sn(t,e,n)))),t},sn=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>Gt(e)||Kt(e)||It(e))(n)){const s=await Qt(n);e.append(t,s)}else if(Array.isArray(n))await Promise.all(n.map((n=>sn(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,s])=>sn(e,`${t}[${n}]`,s))))}}};var rn;async function on(e){const{response:t}=e;if(e.options.stream)return Tn("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Ht.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return Tn("response",t.status,t.url,t.headers,e),an(e,t)}const s=await t.text();return Tn("response",t.status,t.url,t.headers,s),s}function an(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class ln extends Promise{constructor(e,t=on){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new ln(this.responsePromise,(async t=>an(e(await this.parseResponse(t),t),t.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class cn{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:r}){this.baseURL=e,this.maxRetries=kn("maxRetries",t),this.timeout=kn("timeout",n),this.httpAgent=s,this.fetch=r??yt}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...yn(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Cn()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const s=n&&zt(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:s}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:s,query:r,headers:o={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:en(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,a=this.calculateContentLength(i),l=this.buildURL(s,r);"timeout"in e&&kn("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??kt(l),h=c+1e3;return"number"==typeof u?.options?.timeout&&h>(u.options.timeout??0)&&(u.options.timeout=h),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey),{req:{method:n,...i&&{body:i},headers:this.buildHeaders({options:e,headers:o,contentLength:a,retryCount:t}),...u&&{agent:u},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){const r={};n&&(r["content-length"]=n);const o=this.defaultHeaders(e);return An(r,o),An(r,t),en(e.body)&&"node"!==wt&&delete r["content-type"],void 0===On(o,"x-stainless-retry-count")&&void 0===On(t,"x-stainless-retry-count")&&(r["x-stainless-retry-count"]=String(s)),this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,s){return Pt.generate(e,t,n,s)}request(e,t=null){return new ln(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,s=n.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(n);const{req:r,url:o,timeout:i}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(r,{url:o,options:n}),Tn("request",o,n,r.headers),n.signal?.aborted)throw new Tt;const a=new AbortController,l=await this.fetchWithTimeout(o,r,i,a).catch(Sn);if(l instanceof Error){if(n.signal?.aborted)throw new Tt;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new Ot;throw new Ct({cause:l})}const c=dn(l.headers);if(!l.ok){if(t&&this.shouldRetry(l))return Tn(`response (error; retrying, ${t} attempts remaining)`,l.status,o,c),this.retryRequest(n,t,c);const e=await l.text().catch((e=>Sn(e).message)),s=bn(e),r=s?void 0:e;throw Tn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,o,c,r),this.makeStatusError(l.status,s,r,c)}return{response:l,options:n,controller:a}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new hn(this,n,e)}buildURL(e,t){const n=vn(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return En(s)||(t={...s,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new At(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,s){const{signal:r,...o}=t||{};r&&r.addEventListener("abort",(()=>s.abort()));const i=setTimeout((()=>s.abort()),n),a={signal:s.signal,...o};return a.method&&(a.method=a.method.toUpperCase()),this.fetch.call(void 0,e,a).finally((()=>{clearTimeout(i)}))}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let s;const r=n?.["retry-after-ms"];if(r){const e=parseFloat(r);Number.isNaN(e)||(s=e)}const o=n?.["retry-after"];if(o&&!s){const e=parseFloat(o);s=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}return await xn(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${gt}`}}class un{constructor(e,t,n,s){rn.set(this,void 0),function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===s?r.call(e,n):r?r.value=n:t.set(e,n)}(this,rn,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new At("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,s]of n)e.url.searchParams.set(t,s);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)}(this,rn,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(rn=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class hn extends ln{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await on(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const dn=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),pn={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},fn=e=>"object"==typeof e&&null!==e&&!En(e)&&Object.keys(e).every((e=>Rn(pn,e))),mn=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",gn=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let wn;const yn=()=>wn??(wn=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gt,"X-Stainless-OS":gn(Deno.build.os),"X-Stainless-Arch":mn(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gt,"X-Stainless-OS":gn(process.platform),"X-Stainless-Arch":mn(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),bn=e=>{try{return JSON.parse(e)}catch(e){return}},_n=/^[a-z][a-z0-9+.-]*:/i,vn=e=>_n.test(e),xn=e=>new Promise((t=>setTimeout(t,e))),kn=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new At(`${e} must be an integer`);if(t<0)throw new At(`${e} must be a positive integer`);return t},Sn=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},In=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function En(e){if(!e)return!0;for(const t in e)return!1;return!0}function Rn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function An(e,t){for(const n in t){if(!Rn(t,n))continue;const s=n.toLowerCase();if(!s)continue;const r=t[n];null===r?delete e[s]:void 0!==r&&(e[s]=r)}}const Pn=new Set(["authorization","api-key"]);function Tn(e,...t){if("undefined"!=typeof process&&"true"===process?.env?.DEBUG){const n=t.map((e=>{if(!e)return e;if(e.headers){const t={...e,headers:{...e.headers}};for(const n in e.headers)Pn.has(n.toLowerCase())&&(t.headers[n]="REDACTED");return t}let t=null;for(const n in e)Pn.has(n.toLowerCase())&&(t??(t={...e}),t[n]="REDACTED");return t??e}));console.log(`OpenAI:DEBUG:${e}`,...n)}}const Cn=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),On=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const s=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const r of[t,n,t.toUpperCase(),s]){const t=e.get(r);if(t)return t}}for(const[s,r]of Object.entries(e))if(s.toLowerCase()===n)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${t} header, using the first entry.`),r[0]):r};function $n(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Mn extends un{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class jn extends un{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Nn{constructor(e){this._client=e}}let qn=class extends Nn{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}},Ln=class extends Nn{constructor(){super(...arguments),this.completions=new qn(this._client)}};Ln.Completions=qn;class Un extends Nn{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class Dn extends Nn{create(e,t){return this._client.post("/audio/transcriptions",tn({body:e,...t}))}}class Bn extends Nn{create(e,t){return this._client.post("/audio/translations",tn({body:e,...t}))}}class Wn extends Nn{constructor(){super(...arguments),this.transcriptions=new Dn(this._client),this.translations=new Bn(this._client),this.speech=new Un(this._client)}}Wn.Transcriptions=Dn,Wn.Translations=Bn,Wn.Speech=Un;class Fn extends Nn{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return fn(e)?this.list({},e):this._client.getAPIList("/batches",Xn,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Xn extends jn{}Fn.BatchesPage=Xn;class Hn extends Nn{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return fn(e)?this.list({},e):this._client.getAPIList("/assistants",Jn,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Jn extends jn{}function Vn(e){return"function"==typeof e.parse}Hn.AssistantsPage=Jn;const Kn=e=>"assistant"===e?.role,Gn=e=>"function"===e?.role,zn=e=>"tool"===e?.role;var Qn,Yn,Zn,es,ts,ns,ss,rs,os,is,as,ls,cs,us=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},hs=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class ds{constructor(){Qn.add(this),this.controller=new AbortController,Yn.set(this,void 0),Zn.set(this,(()=>{})),es.set(this,(()=>{})),ts.set(this,void 0),ns.set(this,(()=>{})),ss.set(this,(()=>{})),rs.set(this,{}),os.set(this,!1),is.set(this,!1),as.set(this,!1),ls.set(this,!1),us(this,Yn,new Promise(((e,t)=>{us(this,Zn,e,"f"),us(this,es,t,"f")})),"f"),us(this,ts,new Promise(((e,t)=>{us(this,ns,e,"f"),us(this,ss,t,"f")})),"f"),hs(this,Yn,"f").catch((()=>{})),hs(this,ts,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),hs(this,Qn,"m",cs).bind(this))}),0)}_connected(){this.ended||(hs(this,Zn,"f").call(this),this._emit("connect"))}get ended(){return hs(this,os,"f")}get errored(){return hs(this,is,"f")}get aborted(){return hs(this,as,"f")}abort(){this.controller.abort()}on(e,t){return(hs(this,rs,"f")[e]||(hs(this,rs,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=hs(this,rs,"f")[e];if(!n)return this;const s=n.findIndex((e=>e.listener===t));return s>=0&&n.splice(s,1),this}once(e,t){return(hs(this,rs,"f")[e]||(hs(this,rs,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{us(this,ls,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){us(this,ls,!0,"f"),await hs(this,ts,"f")}_emit(e,...t){if(hs(this,os,"f"))return;"end"===e&&(us(this,os,!0,"f"),hs(this,ns,"f").call(this));const n=hs(this,rs,"f")[e];if(n&&(hs(this,rs,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return hs(this,ls,"f")||n?.length||Promise.reject(e),hs(this,es,"f").call(this,e),hs(this,ss,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];hs(this,ls,"f")||n?.length||Promise.reject(e),hs(this,es,"f").call(this,e),hs(this,ss,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function ps(e){return"auto-parseable-response-format"===e?.$brand}function fs(e){return"auto-parseable-tool"===e?.$brand}function ms(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new Bt;if("content_filter"===e.finish_reason)throw new Wt;return{...e,message:{...e.message,tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:fs(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??[],parsed:e.message.content&&!e.message.refusal?gs(t,e.message.content):null}}}));return{...e,choices:n}}function gs(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function ws(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return fs(n)||n?.function.strict||!1}function ys(e){return!!ps(e.response_format)||(e.tools?.some((e=>fs(e)||"function"===e.type&&!0===e.function.strict))??!1)}Yn=new WeakMap,Zn=new WeakMap,es=new WeakMap,ts=new WeakMap,ns=new WeakMap,ss=new WeakMap,rs=new WeakMap,os=new WeakMap,is=new WeakMap,as=new WeakMap,ls=new WeakMap,Qn=new WeakSet,cs=function(e){if(us(this,is,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Tt),e instanceof Tt)return us(this,as,!0,"f"),this._emit("abort",e);if(e instanceof At)return this._emit("error",e);if(e instanceof Error){const t=new At(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new At(String(e)))};var bs,_s,vs,xs,ks,Ss,Is,Es,Rs=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};const As=10;class Ps extends ds{constructor(){super(...arguments),bs.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Gn(e)||zn(e))&&e.content)this._emit("functionCallResult",e.content);else if(Kn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Kn(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new At("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Rs(this,bs,"m",_s).call(this)}async finalMessage(){return await this.done(),Rs(this,bs,"m",vs).call(this)}async finalFunctionCall(){return await this.done(),Rs(this,bs,"m",xs).call(this)}async finalFunctionCallResult(){return await this.done(),Rs(this,bs,"m",ks).call(this)}async totalUsage(){return await this.done(),Rs(this,bs,"m",Ss).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Rs(this,bs,"m",vs).call(this);t&&this._emit("finalMessage",t);const n=Rs(this,bs,"m",_s).call(this);n&&this._emit("finalContent",n);const s=Rs(this,bs,"m",xs).call(this);s&&this._emit("finalFunctionCall",s);const r=Rs(this,bs,"m",ks).call(this);null!=r&&this._emit("finalFunctionCallResult",r),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",Rs(this,bs,"m",Ss).call(this))}async _createChatCompletion(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort()))),Rs(this,bs,"m",Is).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(ms(r,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const s="function",{function_call:r="auto",stream:o,...i}=t,a="string"!=typeof r&&r?.name,{maxChatCompletions:l=As}=n||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,function_call:r,functions:u,messages:[...this.messages]},n),o=t.choices[0]?.message;if(!o)throw new At("missing message in ChatCompletion response");if(!o.function_call)return;const{name:l,arguments:h}=o.function_call,d=c[l];if(!d){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:s,name:l,content:e});continue}if(a&&a!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(a)} requested. Please try again`;this._addMessage({role:s,name:l,content:e});continue}let p;try{p=Vn(d)?await d.parse(h):h}catch(e){this._addMessage({role:s,name:l,content:e instanceof Error?e.message:String(e)});continue}const f=await d.function(p,this),m=Rs(this,bs,"m",Es).call(this,f);if(this._addMessage({role:s,name:l,content:m}),a)return}}async _runTools(e,t,n){const s="tool",{tool_choice:r="auto",stream:o,...i}=t,a="string"!=typeof r&&r?.function?.name,{maxChatCompletions:l=As}=n||{},c=t.tools.map((e=>{if(fs(e)){if(!e.$callback)throw new At("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const h="tools"in t?c.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:r,tools:h,messages:[...this.messages]},n),o=t.choices[0]?.message;if(!o)throw new At("missing message in ChatCompletion response");if(!o.tool_calls?.length)return;for(const e of o.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:r}=e.function,o=u[n];if(!o){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}if(a&&a!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(a)} requested. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}let i;try{i=Vn(o)?await o.parse(r):r}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:s,tool_call_id:t,content:n});continue}const l=await o.function(i,this),c=Rs(this,bs,"m",Es).call(this,l);if(this._addMessage({role:s,tool_call_id:t,content:c}),a)return}}}}bs=new WeakSet,_s=function(){return Rs(this,bs,"m",vs).call(this).content??null},vs=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Kn(t)){const{function_call:e,...n}=t,s={...n,content:t.content??null,refusal:t.refusal??null};return e&&(s.function_call=e),s}}throw new At("stream ended without producing a ChatCompletionMessage with role=assistant")},xs=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Kn(t)&&t?.function_call)return t.function_call;if(Kn(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},ks=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Gn(t)&&null!=t.content)return t.content;if(zn(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},Ss=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Is=function(e){if(null!=e.n&&e.n>1)throw new At("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Es=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Ts extends Ps{static runFunctions(e,t,n){const s=new Ts,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run((()=>s._runFunctions(e,t,r))),s}static runTools(e,t,n){const s=new Ts,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run((()=>s._runTools(e,t,r))),s}_addMessage(e,t=!0){super._addMessage(e,t),Kn(e)&&e.content&&this._emit("content",e.content)}}class Cs extends Error{}class Os extends Error{}const $s=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let s=0;const r=e=>{throw new Cs(`${e} at position ${s}`)},o=e=>{throw new Os(`${e} at position ${s}`)},i=()=>(h(),s>=n&&r("Unexpected end of input"),'"'===e[s]?a():"{"===e[s]?l():"["===e[s]?c():"null"===e.substring(s,s+4)||16&t&&n-s<4&&"null".startsWith(e.substring(s))?(s+=4,null):"true"===e.substring(s,s+4)||32&t&&n-s<4&&"true".startsWith(e.substring(s))?(s+=4,!0):"false"===e.substring(s,s+5)||32&t&&n-s<5&&"false".startsWith(e.substring(s))?(s+=5,!1):"Infinity"===e.substring(s,s+8)||128&t&&n-s<8&&"Infinity".startsWith(e.substring(s))?(s+=8,1/0):"-Infinity"===e.substring(s,s+9)||256&t&&1<n-s&&n-s<9&&"-Infinity".startsWith(e.substring(s))?(s+=9,-1/0):"NaN"===e.substring(s,s+3)||64&t&&n-s<3&&"NaN".startsWith(e.substring(s))?(s+=3,NaN):u()),a=()=>{const i=s;let a=!1;for(s++;s<n&&('"'!==e[s]||a&&"\\"===e[s-1]);)a="\\"===e[s]&&!a,s++;if('"'==e.charAt(s))try{return JSON.parse(e.substring(i,++s-Number(a)))}catch(e){o(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,s-Number(a))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{s++,h();const o={};try{for(;"}"!==e[s];){if(h(),s>=n&&8&t)return o;const r=a();h(),s++;try{const e=i();Object.defineProperty(o,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return o;throw e}h(),","===e[s]&&s++}}catch(e){if(8&t)return o;r("Expected '}' at end of object")}return s++,o},c=()=>{s++;const n=[];try{for(;"]"!==e[s];)n.push(i()),h(),","===e[s]&&s++}catch(e){if(4&t)return n;r("Expected ']' at end of array")}return s++,n},u=()=>{if(0===s){"-"===e&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}o(String(n))}}const i=s;for("-"===e[s]&&s++;e[s]&&!",]}".includes(e[s]);)s++;s!=n||2&t||r("Unterminated number literal");try{return JSON.parse(e.substring(i,s))}catch(n){"-"===e.substring(i,s)&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){o(String(e))}}},h=()=>{for(;s<n&&" \n\r\t".includes(e[s]);)s++};return i()})(e.trim(),t)}(e,509);var Ms,js,Ns,qs,Ls,Us,Ds,Bs,Ws,Fs,Xs,Hs,Js=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n},Vs=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)};class Ks extends Ps{constructor(e){super(),Ms.add(this),js.set(this,void 0),Ns.set(this,void 0),qs.set(this,void 0),Js(this,js,e,"f"),Js(this,Ns,[],"f")}get currentChatCompletionSnapshot(){return Vs(this,qs,"f")}static fromReadableStream(e){const t=new Ks(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const s=new Ks(t);return s._run((()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}async _createChatCompletion(e,t,n){super._createChatCompletion;const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort()))),Vs(this,Ms,"m",Ls).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of r)Vs(this,Ms,"m",Ds).call(this,e);if(r.controller.signal?.aborted)throw new Tt;return this._addChatCompletion(Vs(this,Ms,"m",Fs).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),Vs(this,Ms,"m",Ls).call(this),this._connected();const s=Ht.fromReadableStream(e,this.controller);let r;for await(const e of s)r&&r!==e.id&&this._addChatCompletion(Vs(this,Ms,"m",Fs).call(this)),Vs(this,Ms,"m",Ds).call(this,e),r=e.id;if(s.controller.signal?.aborted)throw new Tt;return this._addChatCompletion(Vs(this,Ms,"m",Fs).call(this))}[(js=new WeakMap,Ns=new WeakMap,qs=new WeakMap,Ms=new WeakSet,Ls=function(){this.ended||Js(this,qs,void 0,"f")},Us=function(e){let t=Vs(this,Ns,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Vs(this,Ns,"f")[e.index]=t,t)},Ds=function(e){if(this.ended)return;const t=Vs(this,Ms,"m",Hs).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const s=Vs(this,Ms,"m",Us).call(this,e);e.finish_reason&&(Vs(this,Ms,"m",Ws).call(this,e),null!=s.current_tool_call_index&&Vs(this,Ms,"m",Bs).call(this,e,s.current_tool_call_index));for(const t of n.delta.tool_calls??[])s.current_tool_call_index!==t.index&&(Vs(this,Ms,"m",Ws).call(this,e),null!=s.current_tool_call_index&&Vs(this,Ms,"m",Bs).call(this,e,s.current_tool_call_index)),s.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&"function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""})}}},Bs=function(e,t){if(Vs(this,Ms,"m",Us).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=Vs(this,js,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:fs(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Ws=function(e){const t=Vs(this,Ms,"m",Us).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=Vs(this,Ms,"m",Xs).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Fs=function(){if(this.ended)throw new At("stream has ended, this shouldn't happen");const e=Vs(this,qs,"f");if(!e)throw new At("request ended without sending any chunks");return Js(this,qs,void 0,"f"),Js(this,Ns,[],"f"),function(e,t){const{id:n,choices:s,created:r,model:o,system_fingerprint:i,...a}=e,l={...a,id:n,choices:s.map((({message:t,finish_reason:n,index:s,logprobs:r,...o})=>{if(!n)throw new At(`missing finish_reason for choice ${s}`);const{content:i=null,function_call:a,tool_calls:l,...c}=t,u=t.role;if(!u)throw new At(`missing role for choice ${s}`);if(a){const{arguments:e,name:l}=a;if(null==e)throw new At(`missing function_call.arguments for choice ${s}`);if(!l)throw new At(`missing function_call.name for choice ${s}`);return{...o,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}return l?{...o,index:s,finish_reason:n,logprobs:r,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map(((t,n)=>{const{function:r,type:o,id:i,...a}=t,{arguments:l,name:c,...u}=r||{};if(null==i)throw new At(`missing choices[${s}].tool_calls[${n}].id\n${Gs(e)}`);if(null==o)throw new At(`missing choices[${s}].tool_calls[${n}].type\n${Gs(e)}`);if(null==c)throw new At(`missing choices[${s}].tool_calls[${n}].function.name\n${Gs(e)}`);if(null==l)throw new At(`missing choices[${s}].tool_calls[${n}].function.arguments\n${Gs(e)}`);return{...a,id:i,type:o,function:{...u,name:c,arguments:l}}}))}}:{...o,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}})),created:r,model:o,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&ys(t)?ms(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,tool_calls:e.message.tool_calls??[]}})))}}(l,t)}(e,Vs(this,js,"f"))},Xs=function(){const e=Vs(this,js,"f")?.response_format;return ps(e)?e:null},Hs=function(e){var t,n,s,r;let o=Vs(this,qs,"f");const{choices:i,...a}=e;o?Object.assign(o,a):o=Js(this,qs,{...a,choices:[]},"f");for(const{delta:i,finish_reason:a,index:l,logprobs:c=null,...u}of e.choices){let e=o.choices[l];if(e||(e=o.choices[l]={finish_reason:a,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:s,refusal:r,...o}=c;Object.assign(e.logprobs,o),s&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...s)),r&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},c);if(a&&(e.finish_reason=a,Vs(this,js,"f")&&ys(Vs(this,js,"f")))){if("length"===a)throw new Bt;if("content_filter"===a)throw new Wt}if(Object.assign(e,u),!i)continue;const{content:h,refusal:d,function_call:p,role:f,tool_calls:m,...g}=i;if(Object.assign(e.message,g),d&&(e.message.refusal=(e.message.refusal||"")+d),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((s=e.message.function_call).arguments??(s.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),h&&(e.message.content=(e.message.content||"")+h,!e.message.refusal&&Vs(this,Ms,"m",Xs).call(this)&&(e.message.parsed=$s(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:s,function:o,...i}of m){const a=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(a,i),n&&(a.id=n),s&&(a.type=s),o&&(a.function??(a.function={name:o.name??"",arguments:""})),o?.name&&(a.function.name=o.name),o?.arguments&&(a.function.arguments+=o.arguments,ws(Vs(this,js,"f"),a)&&(a.function.parsed_arguments=$s(a.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const s=t.shift();s?s.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ht(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Gs(e){return JSON.stringify(e)}class zs extends Ks{static fromReadableStream(e){const t=new zs(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const s=new zs(null),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run((()=>s._runFunctions(e,t,r))),s}static runTools(e,t,n){const s=new zs(t),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run((()=>s._runTools(e,t,r))),s}}let Qs=class extends Nn{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new At(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new At(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>ms(t,e)))}runFunctions(e,t){return e.stream?zs.runFunctions(this._client,e,t):Ts.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?zs.runTools(this._client,e,t):Ts.runTools(this._client,e,t)}stream(e,t){return Ks.createChatCompletion(this._client,e,t)}};class Ys extends Nn{constructor(){super(...arguments),this.completions=new Qs(this._client)}}!function(e){e.Completions=Qs}(Ys);class Zs extends Nn{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class er extends Nn{constructor(){super(...arguments),this.sessions=new Zs(this._client)}}er.Sessions=Zs;var tr,nr,sr,rr,or,ir,ar,lr,cr,ur,hr,dr,pr,fr,mr,gr,wr,yr,br,_r,vr,xr,kr=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},Sr=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};class Ir extends ds{constructor(){super(...arguments),tr.add(this),nr.set(this,[]),sr.set(this,{}),rr.set(this,{}),or.set(this,void 0),ir.set(this,void 0),ar.set(this,void 0),lr.set(this,void 0),cr.set(this,void 0),ur.set(this,void 0),hr.set(this,void 0),dr.set(this,void 0),pr.set(this,void 0)}[(nr=new WeakMap,sr=new WeakMap,rr=new WeakMap,or=new WeakMap,ir=new WeakMap,ar=new WeakMap,lr=new WeakMap,cr=new WeakMap,ur=new WeakMap,hr=new WeakMap,dr=new WeakMap,pr=new WeakMap,tr=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const s=t.shift();s?s.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Ir;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const s=Ht.fromReadableStream(e,this.controller);for await(const e of s)kr(this,tr,"m",fr).call(this,e);if(s.controller.signal?.aborted)throw new Tt;return this._addRun(kr(this,tr,"m",mr).call(this))}toReadableStream(){return new Ht(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s,r){const o=new Ir;return o._run((()=>o._runToolAssistantStream(e,t,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),o}async _createToolAssistantStream(e,t,n,s,r){const o=r?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",(()=>this.controller.abort())));const i={...s,stream:!0},a=await e.submitToolOutputs(t,n,i,{...r,signal:this.controller.signal});this._connected();for await(const e of a)kr(this,tr,"m",fr).call(this,e);if(a.controller.signal?.aborted)throw new Tt;return this._addRun(kr(this,tr,"m",mr).call(this))}static createThreadAssistantStream(e,t,n){const s=new Ir;return s._run((()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}static createAssistantStream(e,t,n,s){const r=new Ir;return r._run((()=>r._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}currentEvent(){return kr(this,hr,"f")}currentRun(){return kr(this,dr,"f")}currentMessageSnapshot(){return kr(this,or,"f")}currentRunStepSnapshot(){return kr(this,pr,"f")}async finalRunSteps(){return await this.done(),Object.values(kr(this,sr,"f"))}async finalMessages(){return await this.done(),Object.values(kr(this,rr,"f"))}async finalRun(){if(await this.done(),!kr(this,ir,"f"))throw Error("Final run was not received.");return kr(this,ir,"f")}async _createThreadAssistantStream(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const r={...t,stream:!0},o=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const e of o)kr(this,tr,"m",fr).call(this,e);if(o.controller.signal?.aborted)throw new Tt;return this._addRun(kr(this,tr,"m",mr).call(this))}async _createAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const o={...n,stream:!0},i=await e.create(t,o,{...s,signal:this.controller.signal});this._connected();for await(const e of i)kr(this,tr,"m",fr).call(this,e);if(i.controller.signal?.aborted)throw new Tt;return this._addRun(kr(this,tr,"m",mr).call(this))}static accumulateDelta(e,t){for(const[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof s)t+=s;else if("number"==typeof t&&"number"==typeof s)t+=s;else{if(!$n(t)||!$n(s)){if(Array.isArray(t)&&Array.isArray(s)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...s);continue}for(const e of s){if(!$n(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const s=t[n];null==s?t.push(e):t[n]=this.accumulateDelta(s,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${t}`)}t=this.accumulateDelta(t,s)}e[n]=t}else e[n]=s;else e[n]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s,r){return await this._createToolAssistantStream(n,e,t,s,r)}}fr=function(e){if(!this.ended)switch(Sr(this,hr,e,"f"),kr(this,tr,"m",yr).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":kr(this,tr,"m",xr).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":kr(this,tr,"m",wr).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":kr(this,tr,"m",gr).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},mr=function(){if(this.ended)throw new At("stream has ended, this shouldn't happen");if(!kr(this,ir,"f"))throw Error("Final run has not been received");return kr(this,ir,"f")},gr=function(e){const[t,n]=kr(this,tr,"m",_r).call(this,e,kr(this,or,"f"));Sr(this,or,t,"f"),kr(this,rr,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,s=t.content[n.index];if(!s||"text"!=s.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,s.text)}if(n.index!=kr(this,ar,"f")){if(kr(this,lr,"f"))switch(kr(this,lr,"f").type){case"text":this._emit("textDone",kr(this,lr,"f").text,kr(this,or,"f"));break;case"image_file":this._emit("imageFileDone",kr(this,lr,"f").image_file,kr(this,or,"f"))}Sr(this,ar,n.index,"f")}Sr(this,lr,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==kr(this,ar,"f")){const t=e.data.content[kr(this,ar,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,kr(this,or,"f"));break;case"text":this._emit("textDone",t.text,kr(this,or,"f"))}}kr(this,or,"f")&&this._emit("messageDone",e.data),Sr(this,or,void 0,"f")}},wr=function(e){const t=kr(this,tr,"m",br).call(this,e);switch(Sr(this,pr,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==kr(this,cr,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(kr(this,ur,"f")&&this._emit("toolCallDone",kr(this,ur,"f")),Sr(this,cr,e.index,"f"),Sr(this,ur,t.step_details.tool_calls[e.index],"f"),kr(this,ur,"f")&&this._emit("toolCallCreated",kr(this,ur,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Sr(this,pr,void 0,"f"),"tool_calls"==e.data.step_details.type&&kr(this,ur,"f")&&(this._emit("toolCallDone",kr(this,ur,"f")),Sr(this,ur,void 0,"f")),this._emit("runStepDone",e.data,t)}},yr=function(e){kr(this,nr,"f").push(e),this._emit("event",e)},br=function(e){switch(e.event){case"thread.run.step.created":return kr(this,sr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=kr(this,sr,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=Ir.accumulateDelta(t,n.delta);kr(this,sr,"f")[e.data.id]=s}return kr(this,sr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":kr(this,sr,"f")[e.data.id]=e.data}if(kr(this,sr,"f")[e.data.id])return kr(this,sr,"f")[e.data.id];throw new Error("No snapshot available")},_r=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const e of s.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=kr(this,tr,"m",vr).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},vr=function(e,t){return Ir.accumulateDelta(t,e)},xr=function(e){switch(Sr(this,dr,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Sr(this,ir,e.data,"f"),kr(this,ur,"f")&&(this._emit("toolCallDone",kr(this,ur,"f")),Sr(this,ur,void 0,"f"))}};class Er extends Nn{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return fn(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Rr,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Rr extends jn{}Er.MessagesPage=Rr;class Ar extends Nn{retrieve(e,t,n,s={},r){return fn(s)?this.retrieve(e,t,n,{},s):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t,n={},s){return fn(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Pr,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class Pr extends jn{}Ar.RunStepsPage=Pr;class Tr extends Nn{constructor(){super(...arguments),this.steps=new Ar(this._client)}create(e,t,n){const{include:s,...r}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return fn(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Cr,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}createAndStream(e,t,n){return Ir.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:o}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await xn(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return Ir.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,s){const r=await this.submitToolOutputs(e,t,n,s);return await this.poll(e,r.id,s)}submitToolOutputsStream(e,t,n,s){return Ir.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,s)}}class Cr extends jn{}Tr.RunsPage=Cr,Tr.Steps=Ar,Tr.RunStepsPage=Pr;class Or extends Nn{constructor(){super(...arguments),this.runs=new Tr(this._client),this.messages=new Er(this._client)}create(e={},t){return fn(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Ir.createThreadAssistantStream(e,this._client.beta.threads,t)}}Or.Runs=Tr,Or.RunsPage=Cr,Or.Messages=Er,Or.MessagesPage=Rr;let $r=class extends Nn{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return fn(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Mr,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const r=await this.retrieve(e,t,{...n,headers:s}).withResponse(),o=r.data;switch(o.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await xn(e);break;case"failed":case"completed":return o}}}async upload(e,t,n){const s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){const s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}};class Mr extends jn{}$r.VectorStoreFilesPage=Mr;class jr extends Nn{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n={},s){return fn(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Mr,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async poll(e,t,n){const s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:r,response:o}=await this.retrieve(e,t,{...n,headers:s}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await xn(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=s?.maxConcurrency??5,o=Math.min(r,t.length),i=this._client,a=t.values(),l=[...n],c=Array(o).fill(a).map((async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},s);l.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const e of t)"fulfilled"===e.status&&s.push(e.value);return s})(c),await this.createAndPoll(e,{file_ids:l})}}class Nr extends Nn{constructor(){super(...arguments),this.files=new $r(this._client),this.fileBatches=new jr(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return fn(e)?this.list({},e):this._client.getAPIList("/vector_stores",qr,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class qr extends jn{}Nr.VectorStoresPage=qr,Nr.Files=$r,Nr.VectorStoreFilesPage=Mr,Nr.FileBatches=jr;class Lr extends Nn{constructor(){super(...arguments),this.realtime=new er(this._client),this.vectorStores=new Nr(this._client),this.chat=new Ys(this._client),this.assistants=new Hn(this._client),this.threads=new Or(this._client)}}Lr.Realtime=er,Lr.VectorStores=Nr,Lr.VectorStoresPage=qr,Lr.Assistants=Hn,Lr.AssistantsPage=Jn,Lr.Threads=Or;class Ur extends Nn{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Dr extends Nn{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}class Br extends Nn{create(e,t){return this._client.post("/files",tn({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return fn(e)?this.list({},e):this._client.getAPIList("/files",Wr,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const s=new Set(["processed","error","deleted"]),r=Date.now();let o=await this.retrieve(e);for(;!o.status||!s.has(o.status);)if(await xn(t),o=await this.retrieve(e),Date.now()-r>n)throw new Ot({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return o}}class Wr extends jn{}Br.FileObjectsPage=Wr;class Fr extends Nn{list(e,t={},n){return fn(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Xr,{query:t,...n})}}class Xr extends jn{}Fr.FineTuningJobCheckpointsPage=Xr;class Hr extends Nn{constructor(){super(...arguments),this.checkpoints=new Fr(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return fn(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Jr,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return fn(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Vr,{query:t,...n})}}class Jr extends jn{}class Vr extends jn{}Hr.FineTuningJobsPage=Jr,Hr.FineTuningJobEventsPage=Vr,Hr.Checkpoints=Fr,Hr.FineTuningJobCheckpointsPage=Xr;class Kr extends Nn{constructor(){super(...arguments),this.jobs=new Hr(this._client)}}Kr.Jobs=Hr,Kr.FineTuningJobsPage=Jr,Kr.FineTuningJobEventsPage=Vr;class Gr extends Nn{createVariation(e,t){return this._client.post("/images/variations",tn({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",tn({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class zr extends Nn{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Qr,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Qr extends Mn{}zr.ModelsPage=Qr;class Yr extends Nn{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Zr extends Nn{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,tn({body:t,...n}))}}class eo extends Nn{constructor(){super(...arguments),this.parts=new Zr(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}var to;eo.Parts=Zr;class no extends cn{constructor({baseURL:e=In("OPENAI_BASE_URL"),apiKey:t=In("OPENAI_API_KEY"),organization:n=In("OPENAI_ORG_ID")??null,project:s=In("OPENAI_PROJECT_ID")??null,...r}={}){if(void 0===t)throw new At("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const o={apiKey:t,organization:n,project:s,...r,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new At("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new Ur(this),this.chat=new Ln(this),this.embeddings=new Dr(this),this.files=new Br(this),this.images=new Gr(this),this.audio=new Wn(this),this.moderations=new Yr(this),this.models=new zr(this),this.fineTuning=new Kr(this),this.beta=new Lr(this),this.batches=new Fn(this),this.uploads=new eo(this),this._options=o,this.apiKey=t,this.organization=n,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let n=e;const s=function(e=pt){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||pt.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=tt;if(void 0!==e.format){if(!at.call(nt,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const s=nt[n];let r,o=pt.filter;if(("function"==typeof e.filter||ct(e.filter))&&(o=e.filter),r=e.arrayFormat&&e.arrayFormat in lt?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":pt.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||pt.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:pt.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:pt.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:pt.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?pt.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:pt.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:pt.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:pt.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:pt.encodeValuesOnly,filter:o,format:n,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:pt.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:pt.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:pt.strictNullHandling}}(t);let r,o;"function"==typeof s.filter?(o=s.filter,n=o("",n)):ct(s.filter)&&(o=s.filter,r=o);const i=[];if("object"!=typeof n||null===n)return"";const a=lt[s.arrayFormat],l="comma"===a&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const c=new WeakMap;for(let e=0;e<r.length;++e){const t=r[e];s.skipNulls&&null===n[t]||ht(i,mt(n[t],t,a,l,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,c))}const u=i.join(s.delimiter);let h=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?h+="utf8=%26%2310003%3B&":h+="utf8=%E2%9C%93&"),u.length>0?h+u:""}(e,{arrayFormat:"brackets"})}}to=no,no.OpenAI=to,no.DEFAULT_TIMEOUT=6e5,no.OpenAIError=At,no.APIError=Pt,no.APIConnectionError=Ct,no.APIConnectionTimeoutError=Ot,no.APIUserAbortError=Tt,no.NotFoundError=Nt,no.ConflictError=qt,no.RateLimitError=Ut,no.BadRequestError=$t,no.AuthenticationError=Mt,no.InternalServerError=Dt,no.PermissionDeniedError=jt,no.UnprocessableEntityError=Lt,no.toFile=Qt,no.fileFromPath=St,no.Completions=Ur,no.Chat=Ln,no.Embeddings=Dr,no.Files=Br,no.FileObjectsPage=Wr,no.Images=Gr,no.Audio=Wn,no.Moderations=Yr,no.Models=zr,no.ModelsPage=Qr,no.FineTuning=Kr,no.Beta=Lr,no.Batches=Fn,no.BatchesPage=Xn,no.Uploads=eo;class so{constructor(e,t,n){this.defaultModel="gpt-4o",t&&(this.defaultModel=t),"undefined"==typeof window||"undefined"==typeof document||"string"!=typeof e&&!e.apiKey||console.warn("\n        ⚠️ Security Warning:\n        DO NOT use API Keys in browser/frontend code!\n        This will expose your credentials and may lead to unauthorized usage.\n        \n        Best Practices: Configure backend API proxy request through baseURL and request headers.\n\n        Please refer to the link: https://eko.fellou.ai/docs/getting-started/configuration#web-environment\n      "),this.client=new no("string"==typeof e?{apiKey:e,dangerouslyAllowBrowser:!0,...n}:e)}buildParams(e,t,n){let s,r;if(t.tools&&t.tools.length>0){s=[];for(let e=0;e<t.tools.length;e++){let n=t.tools[e];s.push({type:"function",function:{name:n.name,description:n.description,parameters:n.input_schema}})}}t.toolChoice&&("auto"==t.toolChoice.type?r="auto":"tool"==t.toolChoice.type&&(r=t.toolChoice.name?{type:"function",function:{name:t.toolChoice.name}}:"required"));let o=[];for(let t=0;t<e.length;t++){let n=e[t];if("assistant"==n.role&&"string"!=typeof n.content){let e,t;for(let s=0;s<n.content.length;s++){let r=n.content[s];"text"==r.type?(e||(e=[]),e.push(r)):"tool_use"==r.type&&(t||(t=[]),t.push({id:r.id,type:"function",function:{name:r.name,arguments:"string"==typeof r.input?r.input:JSON.stringify(r.input)}}))}o.push({role:"assistant",content:e,tool_calls:t})}else if("user"==n.role&&"string"!=typeof n.content)for(let e=0;e<n.content.length;e++){let t=n.content[e];if("text"==t.type)o.push({role:"user",content:t.text});else if("image"==t.type)o.push({role:"user",content:[{type:"image_url",image_url:{url:`data:${t.source.media_type};base64,${t.source.data}`}}]});else if("tool_result"==t.type){let e=[];if("string"==t.content)e.push({type:"text",text:t.content});else for(let n=0;n<t.content.length;n++){let s=t.content[n];"text"==s.type?e.push({...s}):"image"==s.type&&e.push({type:"image_url",image_url:{url:`data:${s.source.media_type};base64,${s.source.data}`}})}e.filter((e=>"image_url"==e.type)).length>0?(o.push({role:"tool",content:"ok",tool_call_id:t.tool_call_id||t.tool_use_id}),o.push({role:"user",content:e})):o.push({role:"tool",content:e,tool_call_id:t.tool_call_id||t.tool_use_id})}}else o.push(n)}return{stream:n,model:t.model||this.defaultModel,max_tokens:t.maxTokens||4096,temperature:t.temperature,messages:o,tools:s,tool_choice:r}}async generateText(e,t){const n=await this.client.chat.completions.create(this.buildParams(e,t,!1));let s=null,r=[],o=null;for(let e=0;e<n.choices.length;e++){let t=n.choices[e],i=t.message;if(i.content&&(null==s&&(s=""),s+=i.content),i.tool_calls)for(let e=0;e<i.tool_calls.length;e++){let t=i.tool_calls[e];r.push({id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)})}t.finish_reason&&(o=t.finish_reason)}let i=[];if(s&&i.push({type:"text",text:s}),r.length>0)for(let e=0;e<r.length;e++){let t=r[e];i.push({type:"tool_use",id:t.id,name:t.name,input:t.input})}return{textContent:s,content:i,toolCalls:r,stop_reason:o}}async generateStream(e,t,n){var s,r,o,i,a,l,c,u,h,d;const p=await this.client.chat.completions.create(this.buildParams(e,t,!0));null===(s=n.onStart)||void 0===s||s.call(n);let f=null,m=[],g=null,w=null;try{for await(const e of p)for(let t=0;t<e.choices.length;t++){let s=e.choices[t];if(s.delta)if(s.delta.content)null==f&&(f=""),f+=s.delta.content,null===(r=n.onContent)||void 0===r||r.call(n,s.delta.content);else if(s.delta.tool_calls&&s.delta.tool_calls.length>0){let e=s.delta.tool_calls[0];w?(e.id&&(w.id=e.id),(null===(a=e.function)||void 0===a?void 0:a.name)&&(w.name=null===(l=e.function)||void 0===l?void 0:l.name),w.accumulatedJson+=(null===(c=e.function)||void 0===c?void 0:c.arguments)||""):w={id:e.id||"",name:(null===(o=e.function)||void 0===o?void 0:o.name)||"",accumulatedJson:(null===(i=e.function)||void 0===i?void 0:i.arguments)||""}}if(s.finish_reason&&(g=s.finish_reason,w)){const e={id:w.id,name:w.name,input:JSON.parse(w.accumulatedJson)};m.push(e),null===(u=n.onToolUse)||void 0===u||u.call(n,e),w=null}}let e=[];if(f&&e.push({type:"text",text:f}),m&&m.length>0)for(let t=0;t<m.length;t++){let n=m[t];e.push({type:"tool_use",id:n.id,name:n.name,input:n.input})}null===(h=n.onComplete)||void 0===h||h.call(n,{textContent:f,content:e,toolCalls:m,stop_reason:g})}catch(e){null===(d=n.onError)||void 0===d||d.call(n,e)}}}const ro={type:"object",required:["id","name","nodes"],properties:{id:{type:"string"},name:{type:"string"},description:{type:"string"},nodes:{type:"array",items:{type:"object",required:["id","type","action"],properties:{id:{type:"string"},type:{type:"string",enum:["action"]},dependencies:{type:"array",items:{type:"string"}},input:{type:"object",properties:{type:{type:"string"},schema:{type:"object"}}},output:{type:"object",properties:{type:{type:"string"},schema:{type:"object"}}},action:{type:"object",required:["type","name","description"],properties:{type:{type:"string",enum:["prompt"]},name:{type:"string"},description:{type:"string"},params:{type:"object"},tools:{type:"array",items:{type:"string"}}}}}}},variables:{type:"object",additionalProperties:!0}}};class oo{constructor(){this.tools=new Map}registerTool(e){this.tools.set(e.name,e)}unregisterTool(e){return this.tools.delete(e)}getTool(e){const t=this.tools.get(e);if(!t)throw new Error(`Tool with name ${e} not found`);return t}hasTools(e){return e.every((e=>this.tools.has(e)))}getAllTools(){return Array.from(this.tools.values())}getToolDefinitions(){return this.getAllTools().map((e=>({name:e.name,description:e.description,input_schema:e.input_schema})))}getToolEnum(){return Array.from(this.tools.keys())}getWorkflowSchema(){const e=JSON.parse(JSON.stringify(ro));return e.properties.nodes.items.properties.action.properties.tools={type:"array",items:{type:"string",enum:this.getToolEnum()}},e}}class io{constructor(e){if(this.toolRegistry=new oo,this.workflowGeneratorMap=new Map,"string"==typeof e)this.llmProvider=new et(e);else if("llm"in e)if("claude"==e.llm){let t=e;this.llmProvider=new et(t.apiKey,t.modelName,t.options)}else{if("openai"!=e.llm)throw new Error("Unknown parameter: llm > "+e.llm);{let t=e;this.llmProvider=new so(t.apiKey,t.modelName,t.options)}}else this.llmProvider=e;io.tools.forEach((e=>this.toolRegistry.registerTool(e)))}async generate(e,t){let n=this.toolRegistry;if(t&&t.tools&&t.tools.length>0){n=new oo;for(let e=0;e<t.tools.length;e++){let s=t.tools[e];"string"==typeof s?n.registerTool(this.getTool(s)):n.registerTool(s)}}const s=new a(this.llmProvider,n),r=await s.generateWorkflow(e);return this.workflowGeneratorMap.set(r,s),r}async execute(e,t){return await e.execute(t)}async modify(e,t){const n=this.workflowGeneratorMap.get(e);return e=await n.modifyWorkflow(t),this.workflowGeneratorMap.set(e,n),e}getTool(e){let t;if(this.toolRegistry.hasTools([e]))t=this.toolRegistry.getTool(e);else{if(!io.tools.has(e))throw new Error(`Tool with name ${e} not found`);t=io.tools.get(e)}return t}async callTool(e,t,n){"string"==typeof e&&(e=this.getTool(e));let s={llmProvider:this.llmProvider,variables:new Map,tools:new Map,callback:n},r=await e.execute(s,t);return e.destroy&&e.destroy(s),r}registerTool(e){this.toolRegistry.registerTool(e)}unregisterTool(e){this.toolRegistry.unregisterTool(e)}}async function ao(e){let t=e.variables.get("windowId");if(t)try{await chrome.windows.get(t)}catch(n){t=null,e.variables.delete("windowId");let s=e.variables.get("tabId");if(s)try{t=(await chrome.tabs.get(s)).windowId}catch(t){e.variables.delete("tabId")}}return t||(t=(await chrome.windows.getCurrent()).id),t}async function lo(e){let t=e.variables.get("tabId");if(t)try{await chrome.tabs.get(t)}catch(n){t=null,e.variables.delete("tabId")}if(!t){let n=e.variables.get("windowId");if(n)try{t=await co(n)}catch(n){t=await co(),e.variables.delete("windowId")}else t=await co()}return t}function co(e){return new Promise((t=>{chrome.tabs.query({windowId:e,active:!0,lastFocusedWindow:!0},(function(n){n.length>0?t(n[0].id):chrome.tabs.query({windowId:e,active:!0,currentWindow:!0},(function(n){n.length>0?t(n[0].id):chrome.tabs.query({windowId:e,status:"complete",currentWindow:!0},(function(e){t(e.length?e[e.length-1].id:void 0)}))}))}))}))}async function uo(e,t,n){let s;if(t){let t=await chrome.windows.create({type:"normal",state:"maximized",url:e});n=t.id,s=(t.tabs||[await chrome.tabs.create({url:e,windowId:n})])[0].id}else n||(n=(await chrome.windows.getCurrent()).id),s=(await chrome.tabs.create({url:e,windowId:n})).id;let r=await po(s);return await fo(200),r}async function ho(e,t,n){return(await chrome.scripting.executeScript({target:{tabId:e},func:t,args:n}))[0].result}async function po(e,t=15e3){return new Promise((async(n,s)=>{let r=await chrome.tabs.get(e);if("complete"===r.status)return void n(r);const o=setTimeout((()=>{chrome.tabs.onUpdated.removeListener(i),s()}),t),i=async(t,s,r)=>{t===e&&"complete"===s.status&&(chrome.tabs.onUpdated.removeListener(i),clearTimeout(o),n(r))};chrome.tabs.onUpdated.addListener(i)}))}function fo(e){return new Promise((t=>setTimeout((()=>t()),e)))}async function mo(e,t){let n=["eko/script/common.js"];t&&n.push("eko/script/"+t),await chrome.scripting.executeScript({target:{tabId:e},files:n})}io.tools=new Map;class go{constructor(e){this.resolve=void 0,this.currentCount=e}countDown(){this.currentCount=this.currentCount-1,this.currentCount<=0&&this.resolve&&this.resolve()}await(e){const t=this;return new Promise(((n,s)=>{let r=n;if(e>0){let t=setTimeout(s,e);r=()=>{clearTimeout(t),n()}}t.resolve=r,t.currentCount<=0&&r()}))}}async function wo(e,t){return t||(t=(await async function(e){return{coordinate:(await chrome.tabs.sendMessage(e,{type:"computer:cursor_position"})).coordinate}}(e)).coordinate),await chrome.tabs.sendMessage(e,{type:"computer:left_click",coordinate:t})}async function yo(e,t){let n;t?(n=await chrome.tabs.captureVisibleTab(e,{format:"jpeg",quality:60}),n=await async function(e,t=.8,n=.8){const s=await createImageBitmap(await(await fetch(e)).blob());let r=s.width*t,o=s.height*t;const i=new OffscreenCanvas(r,o);i.getContext("2d").drawImage(s,0,0,r,o);const a=await i.convertToBlob({type:"image/jpeg",quality:n});return new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(a)}))}(n,.7,1)):n=await chrome.tabs.captureVisibleTab(e,{format:"jpeg",quality:50});let s=n.substring(n.indexOf("base64,")+7);return{image:{type:"base64",media_type:n.indexOf("image/png")>-1?"image/png":"image/jpeg",data:s}}}function bo(e,t,n){const s=new Blob([n],{type:t}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href)}function _o(){const e=e=>{const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&"0"!==t.opacity&&e.offsetWidth>0&&e.offsetHeight>0},t=e=>document.evaluate("preceding::*",e,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotLength,n=(e,t)=>{for(let s=0;s<t.length;s++)e.push(t[s]),t[s].children&&n(e,t[s].children)};let s={},r=1,o=[],i=[];const a="a, button, input, textarea, select";document.querySelectorAll(a).forEach((a=>{if(e(a)&&-1==i.indexOf(a)){const e=r++;s[e.toString()]=a;const l=a.tagName.toLowerCase(),c=Array.from(a.attributes).filter((e=>["id","name","type","value","href","title","placeholder"].includes(e.name))).map((e=>`${"id"==e.name?"target":e.name}="${e.value}"`)).join(" ");o.push({originalIndex:t(a),id:e,html:`<${l} id="${e}" ${c}>${"select"==l?a.innerHTML:a.innerText||""}</${l}>`}),n(i,a.children)}}));const l=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT,{acceptNode:function(t){var n;if(t.matches(a)||-1!=i.indexOf(t))return NodeFilter.FILTER_SKIP;const s=null===(n=t.innerText)||void 0===n?void 0:n.trim();return e(t)&&s&&s.length<=100&&s.length>0&&0===t.children.length?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let c;for(;c=l.nextNode();){const e=r++;s[e.toString()]=c;const n=c.tagName.toLowerCase();o.push({originalIndex:t(c),id:e,html:`<${n} id="${e}">${c.innerText.trim()}</${n}>`})}return o.sort(((e,t)=>e.originalIndex-t.originalIndex)),window.operableElementMap=s,o.map((e=>e.html)).join("\n")}function vo(e){let t=window.operableElementMap[e];return!!t&&(t.click?t.click():t.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0})),!0)}function xo(e){let t=window.operableElementMap[e];if(!t)return null;const n=t.getBoundingClientRect();return{left:n.left+window.scrollX,top:n.top+window.scrollY,right:n.right+window.scrollX,bottom:n.bottom+window.scrollY,width:n.right-n.left,height:n.bottom-n.top}}const ko={"bing.com":{filename:"bing.js",buildSearchUrl:function(e,t){return"https://bing.com/search?q="+encodeURI(t)}},"duckduckgo.com":{filename:"duckduckgo.js",buildSearchUrl:function(e,t){return"https://duckduckgo.com/?q="+encodeURI(t)}},"google.com":{filename:"google.js",buildSearchUrl:function(e,t){return"https://www.google.com/search?q="+encodeURI(t)}},default:{filename:"google.js",buildSearchUrl:function(e,t){let n=(e=e.trim()).indexOf("//");return n>-1&&(e=e.substring(n+2)),n=e.indexOf("/",2),n>-1&&(e=e.substring(0,n)),t="site:"+e+" "+t,"https://www.google.com/search?q="+encodeURIComponent(t)}}};function So(e,t){let n=e.indexOf("/",e.indexOf("//")+2),s=n>-1?e.substring(0,n):e,r=Object.keys(ko),o=null;for(let e=0;e<r.length;e++){let t=r[e];if(s==t||s.endsWith("."+t)||s.endsWith("/"+t)){o=ko[t];break}}return o||(o=ko.default),{filename:o.filename,url:o.buildSearchUrl(e,t)}}const Io=new class{constructor(){this.eventMap={}}addListener(e,t){return t||(t=(new Date).getTime()+""+Math.floor(1e4*Math.random())),this.eventMap[t]=e,t}removeListener(e){delete this.eventMap[e]}async publish(e){let t=Object.values(this.eventMap);for(let s=0;s<t.length;s++)try{let r=t[s](e);(n=r)&&("object"==typeof n||"function"==typeof n)&&"function"==typeof n.then&&await r}catch(e){console.error(e)}var n}};chrome.tabs.onUpdated.addListener((async function(e,t,n){await Io.publish({tabId:e,changeInfo:t,tab:n})}));var Eo=Object.freeze({__proto__:null,BrowserUse:class{constructor(){this.name="browser_use",this.description='Use structured commands to interact with the browser, manipulating page elements through screenshots and webpage element extraction.\n* This is a browser GUI interface where you need to analyze webpages by taking screenshots and extracting page element structures, and specify action sequences to complete designated tasks.\n* Before any operation, you must first call the `screenshot_extract_element` command, which will return the browser page screenshot and structured element information, both specially processed.\n* ELEMENT INTERACTION:\n   - Only use indexes that exist in the provided element list\n   - Each element has a unique index number (e.g., "[33]:<button>")\n   - Elements marked with "[]:" are non-interactive (for context only)\n* NAVIGATION & ERROR HANDLING:\n   - If no suitable elements exist, use other functions to complete the task\n   - If stuck, try alternative approaches\n   - Handle popups/cookies by accepting or closing them\n   - Use scroll to find elements you are looking for',this.input_schema={type:"object",properties:{action:{type:"string",description:"The action to perform. The available actions are:\n* `screenshot_extract_element`: Take a screenshot of the web page and extract operable elements.\n  - Screenshots are used to understand page layouts, with labeled bounding boxes corresponding to element indexes. Each bounding box and its label share the same color, with labels typically positioned in the top-right corner of the box.\n  - Screenshots help verify element positions and relationships. Labels may sometimes overlap, so extracted elements are used to verify the correct elements.\n  - In addition to screenshots, simplified information about interactive elements is returned, with element indexes corresponding to those in the screenshots.\n* `input_text`: Enter a string in the interactive element.\n* `click`: Click to element.\n* `right_click`: Right-click on the element.\n* `double_click`: Double-click on the element.\n* `scroll_to`: Scroll to the specified element.\n* `extract_content`: Extract the text content of the current webpage.\n* `get_dropdown_options`: Get all options from a native dropdown element.\n* `select_dropdown_option`: Select dropdown option for interactive element index by the text of the option you want to select.",enum:["screenshot_extract_element","input_text","click","right_click","double_click","scroll_to","extract_content","get_dropdown_options","select_dropdown_option"]},index:{type:"integer",description:"index of element, Operation elements must pass the corresponding index of the element"},text:{type:"string",description:"Required by `action=input_text` and `action=select_dropdown_option`"}},required:["action"]}}async execute(e,t){var n;try{if(null===t||!t.action)throw new Error('Invalid parameters. Expected an object with a "action" property.');let s,r,o=await lo(e),i=await ao(e),a=e.selector_map;if(null!=t.index&&a&&(s=null===(n=a[t.index])||void 0===n?void 0:n.xpath,!s))throw new Error("Element does not exist");switch(t.action){case"input_text":if(null==t.index)throw new Error("index parameter is required");if(null==t.text)throw new Error("text parameter is required");await async function(e,t,n){return await chrome.tabs.sendMessage(e,{type:"computer:type",text:"",xpath:t,highlightIndex:n})}(o,s,t.index),r=await async function(e,t,n,s){return await chrome.tabs.sendMessage(e,{type:"computer:type",text:t,xpath:n,highlightIndex:s})}(o,t.text,s,t.index),await fo(200);break;case"click":if(null==t.index)throw new Error("index parameter is required");r=await async function(e,t,n){return await chrome.tabs.sendMessage(e,{type:"computer:left_click",xpath:t,highlightIndex:n})}(o,s,t.index),await fo(100);break;case"right_click":if(null==t.index)throw new Error("index parameter is required");r=await async function(e,t,n){return await chrome.tabs.sendMessage(e,{type:"computer:right_click",xpath:t,highlightIndex:n})}(o,s,t.index),await fo(100);break;case"double_click":if(null==t.index)throw new Error("index parameter is required");r=await async function(e,t,n){return await chrome.tabs.sendMessage(e,{type:"computer:double_click",xpath:t,highlightIndex:n})}(o,s,t.index),await fo(100);break;case"scroll_to":if(null==t.index)throw new Error("index parameter is required");r=await async function(e,t,n){return await chrome.tabs.sendMessage(e,{type:"computer:scroll_to",xpath:t,highlightIndex:n})}(o,s,t.index),await fo(500);break;case"extract_content":let n=await chrome.tabs.get(o);await mo(o),await fo(200);let a=await ho(o,(()=>eko.extractHtmlContent()),[]);r={title:n.title,url:n.url,content:a};break;case"get_dropdown_options":if(null==t.index)throw new Error("index parameter is required");r=await async function(e,t,n){return await chrome.tabs.sendMessage(e,{type:"computer:get_dropdown_options",xpath:t,highlightIndex:n})}(o,s,t.index);break;case"select_dropdown_option":if(null==t.index)throw new Error("index parameter is required");if(null==t.text)throw new Error("text parameter is required");r=await async function(e,t,n,s){return await chrome.tabs.sendMessage(e,{type:"computer:select_dropdown_option",text:t,xpath:n,highlightIndex:s})}(o,t.text,s,t.index);break;case"screenshot_extract_element":await fo(100),await mo(o,"build_dom_tree.js"),await fo(100);let l=await ho(o,(()=>window.get_clickable_elements(!0)),[]);e.selector_map=l.selector_map;let c=await yo(i,!0);await ho(o,(()=>window.remove_highlight()),[]),r={image:c.image,text:l.element_str};break;default:throw Error(`Invalid parameters. The "${t.action}" value is not included in the "action" enumeration.`)}return r?{success:!0,...r}:{success:!1}}catch(e){return{success:!1,error:null==e?void 0:e.message}}}destroy(e){delete e.selector_map}},ElementClick:class{constructor(){this.name="element_click",this.description="Click the element through task prompts",this.input_schema={type:"object",properties:{task_prompt:{type:"string",description:"Task prompt, eg: click search button"}},required:["task_prompt"]}}async execute(e,t){if("object"!=typeof t||null===t||!t.task_prompt)throw new Error('Invalid parameters. Expected an object with a "task_prompt" property.');let n,s=t.task_prompt;try{n=await async function(e,t){let n=await lo(e),s=[{role:"user",content:`# Task\nDetermine the operation intent based on user input, find the element ID that the user needs to operate on in the webpage HTML, and if the element does not exist, do nothing.\nOutput JSON format, no explanation required.\n\n# User input\n${t}\n\n# Output example (when the element exists)\n{"elementId": "1", "operationType": "click"}\n\n# Output example (when the element does not exist)\n{"elementId": null, "operationType": "unknown"}\n\n# HTML\n${await ho(n,_o,[])}\n`}],r=await e.llmProvider.generateText(s,{maxTokens:1024}),o="string"==typeof r.content?r.content:r.content[0].text,i=o.substring(o.indexOf("{"),o.indexOf("}")+1),a=JSON.parse(i).elementId;return!!a&&await ho(n,vo,[a])}(e,s)}catch(e){console.log(e),n=!1}return n||(n=await async function(e,t){let n=await lo(e),s=await ao(e),r=[{role:"user",content:[{type:"image",source:(await yo(s,!1)).image},{type:"text",text:"click: "+t}]}],o=(await e.llmProvider.generateText(r,{maxTokens:1024,toolChoice:{type:"tool",name:"left_click"},tools:[{name:"left_click",description:"click element",input_schema:{type:"object",properties:{coordinate:{type:"array",description:"(x, y): The x (pixels from the left edge) and y (pixels from the top edge) coordinates."}},required:["coordinate"]}}]})).toolCalls[0].input.coordinate;return await wo(n,o)}(e,s)),n}},ExportFile:class{constructor(){this.name="export_file",this.description="Content exported as a file, support text format",this.input_schema={type:"object",properties:{fileType:{type:"string",description:"File format type",enum:["txt","csv","md","html","js","xml","json","yml","sql"]},content:{type:"string",description:"Export file content"},filename:{type:"string",description:"File name"}},required:["fileType","content"]}}async execute(e,t){if("object"!=typeof t||null===t||!("content"in t))throw new Error('Invalid parameters. Expected an object with a "content" property.');let n,s="text/plain";switch(t.fileType){case"csv":s="text/csv";break;case"md":s="text/markdown";break;case"html":s="text/html";break;case"js":s="application/javascript";break;case"xml":s="text/xml";break;case"json":s="application/json"}n=t.filename?(t.filename+"").endsWith(t.fileType)?t.filename:t.filename+"."+t.fileType:(new Date).getTime()+"."+t.fileType;let r=await lo(e);try{await chrome.scripting.executeScript({target:{tabId:r},func:bo,args:[n,s,t.content]})}catch(e){r=(await uo("https://www.google.com",!0)).id,await chrome.scripting.executeScript({target:{tabId:r},func:bo,args:[n,s,t.content]}),await fo(1e3),await chrome.tabs.remove(r)}return{success:!0}}},ExtractContent:class{constructor(){this.name="extract_content",this.description="Extract the text content of the current webpage",this.input_schema={type:"object",properties:{}}}async execute(e,t){let n=await lo(e),s=await chrome.tabs.get(n);await mo(n),await fo(500);let r=await ho(n,(()=>eko.extractHtmlContent()),[]);return{tabId:n,result:{title:s.title,url:s.url,content:r}}}},FindElementPosition:class{constructor(){this.name="find_element_position",this.description="Locate Element Coordinates through Task Prompts",this.input_schema={type:"object",properties:{task_prompt:{type:"string",description:"Task prompt, eg: find the search input box"}},required:["task_prompt"]}}async execute(e,t){if("object"!=typeof t||null===t||!t.task_prompt)throw new Error('Invalid parameters. Expected an object with a "task_prompt" property.');let n,s=t.task_prompt;try{n=await async function(e,t){let n=await lo(e),s=[{role:"user",content:`# Task\nFind the element ID that the user needs to operate on in the webpage HTML, and if the element does not exist, do nothing.\nOutput JSON format, no explanation required.\n\n# User input\n${t}\n\n# Output example (when the element exists)\n{"elementId": "1"}\n\n# Output example (when the element does not exist)\n{"elementId": null}\n\n# HTML\n${await ho(n,_o,[])}\n`}],r=await e.llmProvider.generateText(s,{maxTokens:1024}),o="string"==typeof r.content?r.content:r.content[0].text,i=o.substring(o.indexOf("{"),o.indexOf("}")+1),a=JSON.parse(i).elementId;return a?await ho(n,xo,[a]):null}(e,s)}catch(e){console.log(e),n=null}return n||(n=await async function(e,t){await lo(e);let n=await ao(e),s=[{role:"user",content:[{type:"image",source:(await yo(n,!1)).image},{type:"text",text:"Find the element: "+t}]}],r=(await e.llmProvider.generateText(s,{maxTokens:1024,toolChoice:{type:"tool",name:"get_element_by_coordinate"},tools:[{name:"get_element_by_coordinate",description:"Retrieve element information based on coordinate",input_schema:{type:"object",properties:{coordinate:{type:"array",description:"(x, y): The x (pixels from the left edge) and y (pixels from the top edge) coordinates."}},required:["coordinate"]}}]})).toolCalls[0].input.coordinate;return{left:r[0],top:r[1]}}(e,s)),n}},OpenUrl:class{constructor(){this.name="open_url",this.description="Open the specified URL link in browser window",this.input_schema={type:"object",properties:{url:{type:"string",description:"URL link address"},newWindow:{type:"boolean",description:"true: Open in a new window; false: Open in the current window."}},required:["url"]}}async execute(e,t){if("object"!=typeof t||null===t||!t.url)throw new Error('Invalid parameters. Expected an object with a "url" property.');let n,s=t.url,r=t.newWindow;if(r||e.variables.get("windowId")||e.variables.get("tabId")||(r=!0),r)n=await uo(s,!0);else{let t=await ao(e);n=await uo(s,!1,t)}let o=n.windowId,i=n.id;if(e.variables.set("windowId",o),e.variables.set("tabId",i),r){let t=e.variables.get("windowIds");t?t.push(o):e.variables.set("windowIds",[o])}return{tabId:i,windowId:o,title:n.title}}},RequestLogin:class{constructor(){this.name="request_login",this.description="Login to this website, assist with identity verification when manual intervention is needed, guide users through the login process, and wait for their confirmation of successful login.",this.input_schema={type:"object",properties:{}}}async execute(e,t){if(!t.force&&await this.isLoginIn(e))return!0;let n=await lo(e),s="login_required_"+n;const r=setInterval((async()=>{try{(async()=>{await chrome.tabs.sendMessage(n,{type:"request_user_help",task_id:s,failure_type:"login_required",failure_message:"Access page require user authentication."})})()}catch(e){clearInterval(r)}}),2e3);try{return await this.awaitLogin(n,s)}finally{clearInterval(r)}}async awaitLogin(e,t){return new Promise((n=>{const s=setInterval((async()=>{await async function(e){return await new Promise((t=>{chrome.tabs.get(e,(e=>{chrome.runtime.lastError?t(!1):t(!0)}))}))}(e)||(clearInterval(s),n(!1),chrome.runtime.onMessage.removeListener(r))}),1e3),r=e=>{"issue_resolved"===e.type&&e.task_id===t&&(n(!0),clearInterval(s))};chrome.runtime.onMessage.addListener(r)}))}async isLoginIn(e){let t=await ao(e),n=[{role:"user",content:[{type:"image",source:(await yo(t,!0)).image},{type:"text",text:"Check if the current website is logged in. If not logged in, output `NOT_LOGIN`. If logged in, output `LOGGED_IN`. Output directly without explanation."}]}],s=await e.llmProvider.generateText(n,{maxTokens:256}),r=s.textContent;return r||(r=JSON.stringify(s.content)),r.indexOf("LOGGED_IN")>-1}},Screenshot:class{constructor(){this.name="screenshot",this.description="Screenshot the current webpage window",this.input_schema={type:"object",properties:{}}}async execute(e,t){let n=await ao(e);return await yo(n)}},TabManagement:class{constructor(){this.name="tab_management",this.description="Browser tab management, view and operate tabs",this.input_schema={type:"object",properties:{commond:{type:"string",description:"The commond to perform. The available commonds are:\n* `tab_all`: View all tabs and return the tabId and title.\n* `current_tab`: Get current tab information (tabId, url, title).\n* `go_back`: Go back to the previous page in the current tab.\n* `change_url [url]`: open URL in the current tab, eg: `change_url https://www.google.com`.\n* `close_tab`: Close the current tab.\n* `switch_tab [tabId]`: Switch to the specified tab using tabId, eg: `switch_tab 1000`.\n* `new_tab [url]`: Open a new tab window and open the URL, eg: `new_tab https://www.google.com`"}},required:["commond"]}}async execute(e,t){if(null===t||!t.commond)throw new Error('Invalid parameters. Expected an object with a "commond" property.');let n,s=await ao(e),r=t.commond.trim();if(r.startsWith("`")&&(r=r.substring(1)),r.endsWith("`")&&(r=r.substring(0,r.length-1)),"tab_all"==r){n=[];let e=await chrome.tabs.query({windowId:s});for(let t=0;t<e.length;t++){let s=e[t],r={tabId:s.id,windowId:s.windowId,title:s.title,url:s.url};s.active&&(r.active=!0),n.push(r)}}else if("current_tab"==r){let t=await lo(e),s=await chrome.tabs.get(t);n={tabId:t,windowId:s.windowId,title:s.title,url:s.url}}else if("go_back"==r){let t=await lo(e);await chrome.tabs.goBack(t);let s=await chrome.tabs.get(t);n={tabId:t,windowId:s.windowId,title:s.title,url:s.url}}else if("close_tab"==r){let t=await lo(e);await chrome.tabs.remove(t),await fo(100);let s=await chrome.tabs.query({active:!0,currentWindow:!0});0==s.length&&(s=await chrome.tabs.query({status:"complete",currentWindow:!0}));let r=s[s.length-1];r.active||await chrome.tabs.update(r.id,{active:!0});let o=r.id;e.variables.set("tabId",r.id),e.variables.set("windowId",r.windowId),n={closedTabId:t,newTabId:o,newTabTitle:r.title}}else if(r.startsWith("switch_tab")){let t=parseInt(r.replace("switch_tab","").replace("[","").replace("]","")),s=await chrome.tabs.update(t,{active:!0});e.variables.set("tabId",s.id),e.variables.set("windowId",s.windowId),n={tabId:t,windowId:s.windowId,title:s.title,url:s.url}}else if(r.startsWith("change_url")){let t=r.substring(10).replace("[","").replace("]","").trim(),s=await lo(e);await ho(s,(()=>{location.href=t}),[]);let o=await po(s);n={tabId:s,windowId:o.windowId,title:o.title,url:o.url}}else{if(!r.startsWith("new_tab"))throw Error("Unknown commond: "+r);{let t,s=r.replace("new_tab","").replace("[","").replace("]","").replace(/"/g,""),o=!e.variables.get("windowId")&&!e.variables.get("tabId");if(o)t=await uo(s,!0);else{let n=await ao(e);t=await uo(s,!1,n)}let i=t.windowId,a=t.id;if(e.variables.set("windowId",i),e.variables.set("tabId",a),o){let t=e.variables.get("windowIds");t?t.push(i):e.variables.set("windowIds",[i])}n={tabId:t.id,windowId:t.windowId,title:t.title,url:t.url}}}return n}destroy(e){let t=e.variables.get("windowIds");if(t)for(let e=0;e<t.length;e++)chrome.windows.remove(t[e])}},WebSearch:class{constructor(){this.name="web_search",this.description="Use web search to return search results",this.input_schema={type:"object",properties:{query:{type:"string",description:"search for keywords"},maxResults:{type:"integer",description:"Maximum search results, default 5"}},required:["query"]}}async execute(e,t){var n;if("object"!=typeof t||null===t||!t.query)throw new Error('Invalid parameters. Expected an object with a "query" property.');let s=t.url,r=t.query,o=t.maxResults;s||(s="https://www.google.com");let i=(new Date).getTime()+"",a=[{url:s,keyword:r}],l=await async function(e,t,n,s){let r=!1;s||(s=await chrome.windows.create({type:"normal",state:"maximized",url:null}),r=!0);let o=await async function(e,t,n,s){let r=[],o=new go(t.length);for(let i=0;i<t.length;i++)try{const{filename:a,url:l}=So(t[i].url,t[i].keyword);let c=await chrome.tabs.create({url:l,windowId:s.id}),u=e+"_"+i;Io.addListener((async function(e){if(e.tabId==c.id)if("complete"===e.changeInfo.status){Io.removeListener(u),await mo(c.id,a),await fo(1e3);let e=await chrome.tabs.sendMessage(c.id,{type:"page:getDetailLinks",keyword:t[i].keyword});e&&e.links||(e={links:[]}),console.log("detailLinks: ",e);let s=e.links.slice(0,n);r.push({url:l,links:s,filename:a}),o.countDown(),chrome.tabs.remove(c.id)}else"unloaded"===e.changeInfo.status&&(o.countDown(),chrome.tabs.remove(c.id),Io.removeListener(u))}),u)}catch(e){console.error(e),o.countDown()}return await o.await(3e4),r}(e,t,n,s),i=await async function(e,t,n){const s={total:0,running:0,succeed:0,failed:0,failedLinks:[],result:t};for(let e=0;e<t.length;e++){let n=t[e].links;s.total+=n.length}let r=new go(s.total);for(let o=0;o<t.length;o++){let i=t[o].filename,a=t[o].links;for(let t=0;t<a.length;t++){let l=a[t],c=await chrome.tabs.create({url:l.url,windowId:n.id});s.running++;let u=e+"_"+o+"_"+t;Io.addListener((async function(e){if(e.tabId==c.id)if("complete"===e.changeInfo.status)try{Io.removeListener(u),await mo(c.id,i),await fo(1e3);let e=await chrome.tabs.sendMessage(c.id,{type:"page:getContent"});if(!e)throw Error("No Result");l.content=e.content,l.page_title=e.title,s.succeed++}catch(e){s.failed++,s.failedLinks.push(l),console.error(l.title+" crawler error",l.url,e)}finally{s.running--,r.countDown(),chrome.tabs.remove(c.id),Io.removeListener(u)}else"unloaded"===e.changeInfo.status&&(s.running--,r.countDown(),chrome.tabs.remove(c.id),Io.removeListener(u))}),u)}}return await r.await(6e4),s}(e,o,s);return console.log("searchInfo: ",i),r&&chrome.windows.remove(s.id),i}(i,a,o||5);return((null===(n=l.result[0])||void 0===n?void 0:n.links)||[]).filter((e=>e.content))}}});function Ro(e,t){chrome.runtime.sendMessage({type:"log",log:e,level:t||"info"})}chrome.storage.local.set({running:!1}),io.tools=function(){let e=new Map;for(const t in Eo){let n=Eo[t];if("function"==typeof n&&n.prototype&&"execute"in n.prototype)try{let s=new n;e.set(s.name||t,s)}catch(e){console.error(`Failed to instantiate ${t}:`,e)}}return e}(),chrome.runtime.onMessage.addListener((async function(e,t,n){if("run"==e.type)try{chrome.runtime.sendMessage({type:"log",log:"Run..."}),await async function(e){let t=await async function(e="llmConfig"){return(await chrome.storage.sync.get([e]))[e]}();if(!t||!t.apiKey)return void Ro("Please configure apiKey","error");let n=new io(t);const s=await n.generate(e);await n.execute(s,{hooks:{beforeWorkflow:async e=>{Ro("Start workflow: "+e.name)},beforeSubtask:async(e,t)=>{Ro("> subtask: "+e.name)},beforeToolUse:async(e,t,n)=>(Ro("> tool: "+e.name),n),afterToolUse:async(e,t,n)=>(Ro("  tool: "+e.name+" completed","success"),n),afterSubtask:async(e,t,n)=>{Ro("  subtask: "+e.name+" completed","success")},afterWorkflow:async(e,t)=>{Ro("Completed","success")}}})}(e.prompt)}catch(e){chrome.runtime.sendMessage({type:"log",log:e.message,level:"error"})}finally{chrome.storage.local.set({running:!1}),chrome.runtime.sendMessage({type:"stop"})}}))})();